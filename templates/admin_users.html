{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
  <div>
    <h1 class="h3 mb-0 fw-bold">Admin: Users & Tanks</h1>
    <div class="text-muted small">Manage roles, tank access, and assignments.</div>
  </div>
  <a class="btn btn-outline-secondary" href="/">
    <i class="bi bi-arrow-left"></i> Back to Dashboard
  </a>
</div>

<div class="row g-4">
  {% for u in users %}
    {% set assigned_ids = user_tanks_map.get(u.id, []) %}
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="fw-bold">{{ u.email }}</div>
            <div class="small text-muted">Created {{ u.created_at|dtfmt }}</div>
          </div>
          <form method="post" action="/admin/users/{{ u.id }}/role" class="d-flex align-items-center gap-2">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" name="admin" id="admin-{{ u.id }}" {% if u.admin or u.role == "admin" %}checked{% endif %}>
              <label class="form-check-label small" for="admin-{{ u.id }}">Admin</label>
            </div>
            <button class="btn btn-sm btn-outline-primary" type="submit">Update Role</button>
          </form>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="text-muted small mb-2">Assigned tanks</div>
            {% if assigned_ids %}
              <div class="d-flex flex-wrap gap-2">
                {% for t in tanks if t.id in assigned_ids %}
                  <span class="badge bg-light text-dark border">{{ t.name }}</span>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted small">No tanks assigned.</div>
            {% endif %}
          </div>

          <form method="post" action="/admin/users/{{ u.id }}/tanks">
            <div class="text-muted small mb-2">Update tank access</div>
            <div class="row g-2">
              {% for t in tanks %}
                <div class="col-md-4 col-sm-6">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="tank_ids"
                      id="tank-{{ u.id }}-{{ t.id }}"
                      value="{{ t.id }}"
                      {% if t.id in assigned_ids %}checked{% endif %}
                    >
                    <label class="form-check-label" for="tank-{{ u.id }}-{{ t.id }}">
                      {{ t.name }}
                      {% if t.owner_user_id == u.id %}
                        <span class="badge bg-primary-subtle text-primary border ms-1">Owner</span>
                      {% endif %}
                    </label>
                  </div>
                </div>
              {% endfor %}
              {% if tanks|length == 0 %}
                <div class="col-12 text-muted small">No tanks found.</div>
              {% endif %}
            </div>
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-primary" type="submit">Save Tank Access</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
  {% if users|length == 0 %}
    <div class="col-12 text-center text-muted">No users found.</div>
  {% endif %}
</div>
{% endblock %}
