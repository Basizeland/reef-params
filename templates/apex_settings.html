{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h2 class="h5 mb-1">Apex Integration</h2>
        <div class="text-muted small">Connect to a Neptune Apex controller and import probe readings.</div>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger mt-3">{{ error }}</div>
    {% endif %}
    {% if success %}
      <div class="alert alert-success mt-3">{{ success }}</div>
    {% endif %}

    <form class="mt-4" method="post" action="/settings/integrations/apex/save">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Integration</label>
          <select class="form-select" name="integration_id">
            {% for integration in integrations %}
              <option value="{{ integration.id }}" {% if integration_id == integration.id %}selected{% endif %}>
                {{ integration.name or integration.host or ("Integration " ~ loop.index) }}
              </option>
            {% endfor %}
            <option value="new">+ New integration</option>
          </select>
          <div class="form-text">Create one integration per Apex or share a single Apex across tanks.</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Integration Name</label>
          <input class="form-control" name="name" value="{{ settings.name }}" placeholder="e.g. Apex Living Room" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Apex Base URL</label>
          <input class="form-control" name="host" value="{{ settings.host }}" placeholder="http://192.168.1.50" />
          <div class="form-text">Use the local IP of your Apex controller.</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Tanks</label>
          <select class="form-select" name="tank_ids" multiple>
            {% for tank in tanks %}
              {% set is_selected = (tank.id in settings.tank_ids) or (settings.tank_id == tank.id) %}
              <option value="{{ tank.id }}" {% if is_selected %}selected{% endif %}>{{ tank.name }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Select one or more tanks to import readings into.</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Username</label>
          <input class="form-control" name="username" value="{{ settings.username }}" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Password</label>
          <input class="form-control" name="password" type="password" value="" placeholder="Leave blank to keep" />
        </div>
        <div class="col-md-4">
          <label class="form-label">API Token</label>
          <input class="form-control" name="api_token" type="password" value="" placeholder="Optional bearer token" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Poll Interval (minutes)</label>
          <input class="form-control" name="poll_interval_minutes" value="{{ settings.poll_interval_minutes }}" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="enabled" id="apex-enabled" {% if settings.enabled %}checked{% endif %} />
            <label class="form-check-label" for="apex-enabled">Enable server polling</label>
          </div>
        </div>
        <div class="col-12">
          <div class="form-text">
            Server polling requires the Apex to be reachable from this server. Leave off for browser-based imports.
          </div>
        </div>
        <div class="col-12">
          <div class="alert alert-secondary small mb-0">
            Load probes to map them to your parameters using the table below.
            {% if last_probe_loaded_at %}
              <span class="ms-2 text-muted">Last loaded at {{ last_probe_loaded_at }}.</span>
            {% endif %}
          </div>
        </div>
      </div>

      {% if probes %}
        <div class="mt-4">
          <h3 class="h6 text-uppercase text-muted">Probe Mapping</h3>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Probe</th>
                  <th>Parameter</th>
                </tr>
              </thead>
              <tbody>
                {% for probe in probes %}
                  <tr>
                    <td class="fw-semibold">{{ probe }}</td>
                    <td>
                      <input type="hidden" name="probe_name" value="{{ probe }}" />
                      <select class="form-select form-select-sm" name="param_name">
                        <option value="">Select parameter</option>
                        {% for param in parameters %}
                          {% set selected_param = mapping.get(probe) or auto_mapping.get(probe) %}
                          <option value="{{ param.name }}" {% if selected_param == param.name %}selected{% endif %}>
                            {{ param.name }}
                          </option>
                        {% endfor %}
                      </select>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      <div class="d-flex flex-wrap gap-2 mt-4">
        <button class="btn btn-primary" type="submit">Save Settings</button>
        <button class="btn btn-outline-secondary" type="submit" formaction="/settings/integrations/apex/test" formmethod="post">Test Connection</button>
        <button class="btn btn-outline-secondary" type="submit" formaction="/settings/integrations/apex/probes" formmethod="post">Load Probes</button>
        <button class="btn btn-outline-secondary" type="submit" formaction="/settings/integrations/apex/preview" formmethod="post">Preview Mapping</button>
      </div>
    </form>

    {% if preview %}
      <div class="mt-4">
        <h3 class="h6 text-uppercase text-muted">Preview</h3>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Probe</th>
                <th>Parameter</th>
                <th>Value</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody>
              {% for row in preview %}
                <tr>
                  <td class="fw-semibold">{{ row.probe }}</td>
                  <td>{{ row.parameter }}</td>
                  <td>{{ row.value }} {{ row.unit }}</td>
                  <td class="text-muted small">{{ row.timestamp }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    <form class="mt-4" method="post" action="/settings/integrations/apex/import">
      <input type="hidden" name="integration_id" value="{{ integration_id }}">
      <button class="btn btn-outline-primary" type="submit">Import Now (Server)</button>
      <button class="btn btn-outline-secondary" type="button" id="apex-client-import" data-integration-id="{{ integration_id }}">
        Import via Browser
      </button>
    </form>
  </div>
</div>

<div class="apex-loading d-none align-items-center justify-content-center" id="apex-loading-overlay">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-3 fw-semibold">Working on Apex integrationâ€¦</div>
  </div>
</div>

<style>
  .apex-loading {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.85);
    z-index: 1050;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById("apex-loading-overlay");
    const forms = document.querySelectorAll("form[action^='/settings/integrations/apex']");
    forms.forEach((form) => {
      form.addEventListener("submit", () => {
        if (overlay) {
          overlay.classList.remove("d-none");
          overlay.classList.add("d-flex");
        }
        const buttons = form.querySelectorAll("button, input[type='submit']");
        buttons.forEach((button) => button.setAttribute("disabled", "disabled"));
      });
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const button = document.getElementById("apex-client-import");
    const overlay = document.getElementById("apex-loading-overlay");
    const hostInput = document.querySelector("input[name='host']");
    if (!button || !hostInput) return;

    const showOverlay = () => {
      if (!overlay) return;
      overlay.classList.remove("d-none");
      overlay.classList.add("d-flex");
    };

    const buildUrls = (rawHost) => {
      const trimmed = (rawHost || "").trim();
      if (!trimmed) return [];
      const endpoints = ["/cgi-bin/status.xml", "/rest/status", "/rest/status.json", "/rest/"];
      if (trimmed.includes("://")) {
        try {
          const url = new URL(trimmed);
          if (url.pathname && url.pathname !== "/") {
            return [url.toString()];
          }
          return endpoints.map((endpoint) => `${url.origin}${endpoint}`);
        } catch (err) {
          return [];
        }
      }
      if (trimmed.includes("/")) {
        const [hostOnly, ...pathParts] = trimmed.split("/");
        const path = `/${pathParts.join("/")}`;
        return [`http://${hostOnly}${path}`, `https://${hostOnly}${path}`];
      }
      return [
        ...endpoints.map((endpoint) => `http://${trimmed}${endpoint}`),
        ...endpoints.map((endpoint) => `https://${trimmed}${endpoint}`),
      ];
    };

    const fetchPayload = async (rawHost) => {
      const urls = buildUrls(rawHost);
      let lastError = null;
      for (const url of urls) {
        try {
          const response = await fetch(url, { cache: "no-store", credentials: "omit" });
          if (!response.ok) {
            lastError = new Error(`Request failed (${response.status})`);
            continue;
          }
          const text = await response.text();
          if (text) {
            return { payload: text, source: url };
          }
        } catch (err) {
          lastError = err;
        }
      }
      throw lastError || new Error("Unable to reach Apex from the browser.");
    };

    button.addEventListener("click", async () => {
      const host = hostInput.value;
      if (!host) {
        alert("Enter the Apex host before importing.");
        return;
      }
      showOverlay();
      button.setAttribute("disabled", "disabled");
      try {
        const payload = await fetchPayload(host);
        const response = await fetch("/settings/integrations/apex/client-import", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            integration_id: button.dataset.integrationId || "",
            payload: payload.payload,
          }),
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || "Client import failed.");
        }
        alert(data.success || "Imported Apex readings.");
        window.location.reload();
      } catch (err) {
        alert(err?.message || "Unable to import from Apex via browser.");
      } finally {
        button.removeAttribute("disabled");
        if (overlay) {
          overlay.classList.add("d-none");
          overlay.classList.remove("d-flex");
        }
      }
    });
  });
</script>
{% endblock %}
