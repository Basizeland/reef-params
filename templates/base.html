<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reef Metrics</title>
    <meta name="theme-color" content="#0b1f33">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Reef Metrics">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/app-icon-192.png">
    <link rel="apple-touch-startup-image" href="/static/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/static/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/static/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/static/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/static/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/static/splash-1179x2556.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/static/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/static/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/static/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="/static/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/static/splash-1668x2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/static/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/static/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="preload" href="/static/style.css?v=8" as="style">
    <link rel="stylesheet" href="/static/style.css?v=8">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light mb-4 sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/static/logo-light.png" alt="Reef Metrics" class="brand-logo-img" height="36" width="150">
            </a>
            <div class="collapse navbar-collapse me-auto" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house-door"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/insights"><i class="bi bi-graph-up-arrow"></i> Insights</a></li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-tools"></i> Tools
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                            <li><a class="dropdown-item" href="/tanks/multi-add"><i class="bi bi-clipboard-plus"></i> Log test for all tanks</a></li>
                            <li><a class="dropdown-item" href="/tools/calculators"><i class="bi bi-calculator"></i> Dosing Calculator</a></li>
                            <li><a class="dropdown-item" href="/tools/dose-plan"><i class="bi bi-calendar-check"></i> Dose Planner</a></li>
                            <li><a class="dropdown-item" href="/tools/icp"><i class="bi bi-file-earmark-spreadsheet"></i> ICP Import</a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Manage
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                            <li><a class="dropdown-item" href="/settings/parameters"><i class="bi bi-sliders"></i> Parameters</a></li>
                            <li><a class="dropdown-item" href="/additives"><i class="bi bi-droplet"></i> Additives</a></li>
                            <li><a class="dropdown-item" href="/settings/test-kits"><i class="bi bi-eyedropper"></i> Test Kits</a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% if request.state.user is defined and request.state.user and request.state.user.admin %}
                                <li>
                                    <a class="dropdown-item fw-bold text-primary" href="/admin/import">
                                        <i class="bi bi-database"></i> Data Center
                                    </a>
                                </li>
                                <li><a class="dropdown-item" href="/settings/system"><i class="bi bi-gear"></i> System Settings</a></li>
                                <li><a class="dropdown-item" href="/settings/integrations/apex"><i class="bi bi-plug"></i> Apex Integration</a></li>
                                <li><a class="dropdown-item" href="/admin/users"><i class="bi bi-people"></i> Users</a></li>
                                <li><a class="dropdown-item" href="/admin/icp-uploads"><i class="bi bi-cloud-upload"></i> ICP Uploads</a></li>
                                <li><a class="dropdown-item" href="/admin/audit"><i class="bi bi-journal-text"></i> Audit Log</a></li>
                                <li><a class="dropdown-item" href="/pwa/checklist"><i class="bi bi-check2-square"></i> PWA Checklist</a></li>
                            {% else %}
                                <li>
                                    <span class="dropdown-item text-muted">
                                        <i class="bi bi-database"></i> Data Center (admin only)
                                    </span>
                                </li>
                            {% endif %}
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="d-flex align-items-center gap-2 ms-auto">
                <a class="nav-link d-none d-lg-inline" href="/account"><i class="bi bi-person-circle"></i> Account</a>
                {% set global_notifications = global_dosing_notifications(request) %}
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle position-relative" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-bell"></i>
                        {% if global_notifications %}
                            <span class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-danger">
                                {{ global_notifications|length }}
                            </span>
                        {% endif %}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm notification-menu" style="min-width: 320px;">
                        <li class="dropdown-header text-uppercase small text-muted">Notifications</li>
                        <li>
                            <a class="dropdown-item" href="/alerts">
                                <i class="bi bi-bell"></i> Alert Center
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% if global_notifications %}
                            {% for group in global_notifications|groupby('tank_id') %}
                                {% set alerts = group.list %}
                                <li class="dropdown-item text-wrap">
                                    <div class="fw-semibold">{{ alerts[0].tank_name }}</div>
                                    {% for alert in alerts %}
                                        <div class="d-flex align-items-start justify-content-between gap-2 mt-2">
                                            <a class="text-decoration-none text-reset small" href="/tanks/{{ alert.tank_id }}">
                                                {{ alert.label }}: {{ alert.days|round(1) }} days remaining (≤ {{ alert.threshold }})
                                            </a>
                                            <div class="d-flex flex-column gap-1">
                                                <form method="post" action="/tanks/{{ alert.tank_id }}/dosing-containers">
                                                    <input type="hidden" name="action" value="refill">
                                                    <input type="hidden" name="container_key" value="{{ alert.container_key }}">
                                                    <button class="btn btn-sm btn-outline-primary" type="submit">Refill</button>
                                                </form>
                                                <form method="post" action="/notifications/dismiss">
                                                    <input type="hidden" name="tank_id" value="{{ alert.tank_id }}">
                                                    <input type="hidden" name="container_key" value="{{ alert.container_key }}">
                                                    <input type="hidden" name="notified_on" value="{{ alert.notified_on }}">
                                                    <button class="btn btn-sm btn-outline-secondary" type="submit">Dismiss</button>
                                                </form>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </li>
                                <li><hr class="dropdown-divider"></li>
                            {% endfor %}
                        {% else %}
                            <li class="dropdown-item text-muted small">No dosing alerts right now.</li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-item">
                            <div class="d-flex align-items-center justify-content-between gap-2">
                                <div>
                                    <div class="fw-semibold small">Push alerts</div>
                                    <div class="text-muted small">Enable browser push notifications.</div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary js-enable-browser-alerts" type="button" data-status-target="browser-alerts-status">
                                    <span id="browser-alerts-status">Off</span>
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="alert alert-info d-none pwa-banner" role="alert" id="pwa-install-banner">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <strong>Install Reef Metrics</strong>
                    <div class="small text-muted">Add this app to your home screen for quick access.</div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" type="button" id="pwa-install-btn">Install</button>
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="pwa-install-dismiss">Not now</button>
                </div>
            </div>
        </div>
        <div class="alert alert-info d-none pwa-banner" role="alert" id="pwa-ios-banner">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <strong>Add to Home Screen</strong>
                    <div class="small text-muted">Tap Share → Add to Home Screen in Safari.</div>
                </div>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="pwa-ios-dismiss">Got it</button>
            </div>
        </div>
        <div class="alert alert-warning d-none offline-banner" role="alert" id="offline-banner">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <strong>You're offline</strong>
                    <div class="small text-muted">Check your connection and try again.</div>
                </div>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="offline-retry">Retry</button>
            </div>
        </div>
    </div>

    <div class="container pb-5 mobile-content-pad">
        {% block content %}{% endblock %}
    </div>

    <nav class="bottom-nav d-lg-none position-fixed start-50 translate-middle-x">
        <div class="d-flex justify-content-around align-items-center">
            <a class="nav-link {% if request.url.path == '/' %}active{% endif %}" href="/">
                <i class="bi bi-house-door"></i>
                <span>Home</span>
            </a>
            <a class="nav-link {% if request.url.path == '/tools/calculators' %}active{% endif %}" href="/tools/calculators">
                <i class="bi bi-calculator"></i>
                <span>Dosing Calc</span>
            </a>
            <a class="nav-link {% if request.url.path.startswith('/tools/dose-plan') %}active{% endif %}" href="/tools/dose-plan">
                <i class="bi bi-calendar-check"></i>
                <span>Dose Plan</span>
            </a>
            {% if request.state.user is defined and request.state.user %}
                <a class="nav-link {% if request.url.path.startswith('/account') %}active{% endif %}" href="/account">
                    <i class="bi bi-person-circle"></i>
                    <span>Account</span>
                </a>
            {% else %}
                <a class="nav-link {% if request.url.path.startswith('/auth/login') %}active{% endif %}" href="/auth/login">
                    <i class="bi bi-box-arrow-in-right"></i>
                    <span>Login</span>
                </a>
            {% endif %}
        </div>
    </nav>

    <div class="modal fade" id="onboardingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Welcome to Reef Metrics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Pick a step, jump to the screen, and mark it complete. You can come back anytime.</p>
                    <div class="mb-3 d-flex align-items-center justify-content-between">
                        <div class="small text-muted"><span data-guide-completed>0</span> of <span data-guide-total>0</span> steps completed</div>
                        <div class="progress flex-grow-1 ms-3" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" data-guide-progress></div>
                        </div>
                    </div>
                    <div class="row g-3" data-guide-list>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100 d-flex flex-column gap-3" data-guide-task="create-tank">
                                <div class="d-flex justify-content-between align-items-start gap-3">
                                    <div>
                                        <div class="fw-semibold text-navy">Create your first tank</div>
                                        <div class="text-muted small">Add your tank name, size, and net water volume.</div>
                                    </div>
                                    <span class="badge bg-success d-none" data-guide-badge>Done</span>
                                </div>
                                <div class="mt-auto d-flex flex-wrap gap-2">
                                    <a class="btn btn-sm btn-primary" href="/tanks/new">Start</a>
                                    <button type="button" class="btn btn-sm btn-outline-success" data-guide-complete>Mark complete</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100 d-flex flex-column gap-3" data-guide-task="log-readings">
                                <div class="d-flex justify-content-between align-items-start gap-3">
                                    <div>
                                        <div class="fw-semibold text-navy">Log your first readings</div>
                                        <div class="text-muted small">Capture current alkalinity, calcium, nitrate, and more.</div>
                                    </div>
                                    <span class="badge bg-success d-none" data-guide-badge>Done</span>
                                </div>
                                <div class="mt-auto d-flex flex-wrap gap-2">
                                    <a class="btn btn-sm btn-primary" href="/add" data-guide-link="log-readings">Log a test</a>
                                    <button type="button" class="btn btn-sm btn-outline-success" data-guide-complete>Mark complete</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100 d-flex flex-column gap-3" data-guide-task="configure-dosing">
                                <div class="d-flex justify-content-between align-items-start gap-3">
                                    <div>
                                        <div class="fw-semibold text-navy">Configure dosing</div>
                                        <div class="text-muted small">Pick dosing methods, set daily amounts, and track containers.</div>
                                    </div>
                                    <span class="badge bg-success d-none" data-guide-badge>Done</span>
                                </div>
                                <div class="mt-auto d-flex flex-wrap gap-2">
                                    <a class="btn btn-sm btn-primary" href="/tanks/new" data-guide-link="configure-dosing">Open dosing</a>
                                    <button type="button" class="btn btn-sm btn-outline-success" data-guide-complete>Mark complete</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100 d-flex flex-column gap-3" data-guide-task="run-tools">
                                <div class="d-flex justify-content-between align-items-start gap-3">
                                    <div>
                                        <div class="fw-semibold text-navy">Use calculators &amp; dose plans</div>
                                        <div class="text-muted small">Dial in dose amounts and schedule future corrections.</div>
                                    </div>
                                    <span class="badge bg-success d-none" data-guide-badge>Done</span>
                                </div>
                                <div class="mt-auto d-flex flex-wrap gap-2">
                                    <a class="btn btn-sm btn-primary" href="/tools/calculators">Open tools</a>
                                    <button type="button" class="btn btn-sm btn-outline-success" data-guide-complete>Mark complete</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100 d-flex flex-column gap-3" data-guide-task="notifications">
                                <div class="d-flex justify-content-between align-items-start gap-3">
                                    <div>
                                        <div class="fw-semibold text-navy">Turn on notifications</div>
                                        <div class="text-muted small">Stay ahead of low containers and reminders.</div>
                                    </div>
                                    <span class="badge bg-success d-none" data-guide-badge>Done</span>
                                </div>
                                <div class="mt-auto d-flex flex-wrap gap-2">
                                    <a class="btn btn-sm btn-primary" href="/account">Manage alerts</a>
                                    <button type="button" class="btn btn-sm btn-outline-success" data-guide-complete>Mark complete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-guide-reset>Reset progress</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <a class="btn btn-primary" href="/">Go to dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script>
        const getCookie = (name) => {
            const match = document.cookie.match(new RegExp(`(^|; )${name}=([^;]*)`));
            return match ? decodeURIComponent(match[2]) : "";
        };
        window.csrfToken = getCookie("csrf_token");

        document.addEventListener("DOMContentLoaded", () => {
            if (!window.csrfToken) return;
            document.querySelectorAll("form").forEach((form) => {
                const method = (form.getAttribute("method") || "get").toLowerCase();
                if (method !== "post") return;
                if (form.querySelector("input[name='csrf_token']")) return;
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "csrf_token";
                input.value = window.csrfToken;
                form.appendChild(input);
            });
        });
        document.addEventListener("DOMContentLoaded", () => {
            if (!window.csrfToken) return;
            document.querySelectorAll("form[enctype='multipart/form-data']").forEach((form) => {
                if (form.dataset.csrfFetchBound) return;
                form.dataset.csrfFetchBound = "true";
                form.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const formData = new FormData(form);
                    const response = await fetch(form.action, {
                        method: (form.method || "post").toUpperCase(),
                        headers: { "X-CSRF-Token": window.csrfToken },
                        body: formData,
                    });
                    const html = await response.text();
                    document.open();
                    document.write(html);
                    document.close();
                });
            });
        });
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/static/service-worker.js").catch(() => {});
        }
        document.addEventListener("DOMContentLoaded", () => {
            const modalEl = document.getElementById("onboardingModal");
            if (!modalEl) return;
            const storageKey = "reefMetricsGuideState";
            const loadState = () => {
                try {
                    const raw = localStorage.getItem(storageKey);
                    if (!raw) return { seen: false, completed: {} };
                    const parsed = JSON.parse(raw);
                    return {
                        seen: Boolean(parsed.seen),
                        completed: parsed.completed && typeof parsed.completed === "object" ? parsed.completed : {},
                    };
                } catch (err) {
                    return { seen: false, completed: {} };
                }
            };
            const saveState = (state) => {
                localStorage.setItem(storageKey, JSON.stringify(state));
            };
            const tasks = Array.from(modalEl.querySelectorAll("[data-guide-task]"));
            if (!tasks.length) return;
            const completedLabel = modalEl.querySelector("[data-guide-completed]");
            const totalLabel = modalEl.querySelector("[data-guide-total]");
            const progress = modalEl.querySelector("[data-guide-progress]");
            const resetBtn = modalEl.querySelector("[data-guide-reset]");

            let state = loadState();

            const getCompletedCount = () => tasks.reduce((count, task) => {
                const id = task.dataset.guideTask;
                return count + (id && state.completed[id] ? 1 : 0);
            }, 0);

            const updateUI = () => {
                const total = tasks.length;
                const completedCount = getCompletedCount();
                if (completedLabel) completedLabel.textContent = completedCount.toString();
                if (totalLabel) totalLabel.textContent = total.toString();
                if (progress) {
                    const percent = total ? Math.round((completedCount / total) * 100) : 0;
                    progress.style.width = `${percent}%`;
                }
                tasks.forEach((task) => {
                    const id = task.dataset.guideTask;
                    const isDone = id && state.completed[id];
                    task.classList.toggle("border-success", Boolean(isDone));
                    task.classList.toggle("bg-success-subtle", Boolean(isDone));
                    const badge = task.querySelector("[data-guide-badge]");
                    if (badge) badge.classList.toggle("d-none", !isDone);
                    const button = task.querySelector("[data-guide-complete]");
                    if (button) {
                        button.textContent = isDone ? "Completed" : "Mark complete";
                        button.classList.toggle("btn-success", Boolean(isDone));
                        button.classList.toggle("btn-outline-success", !isDone);
                    }
                });
            };

            const updateGuideLinks = async () => {
                const linkTargets = {
                    "log-readings": `/add`,
                    "configure-dosing": `/tanks/new`,
                };
                const links = Array.from(modalEl.querySelectorAll("[data-guide-link]"));
                if (!links.length) return;
                try {
                    const response = await fetch("/api/tanks", { credentials: "same-origin" });
                    if (!response.ok) return;
                    const tanks = await response.json();
                    if (!Array.isArray(tanks) || !tanks.length || !tanks[0].id) return;
                    const firstTankId = tanks[0].id;
                    linkTargets["log-readings"] = `/tanks/${firstTankId}/add`;
                    linkTargets["configure-dosing"] = `/tanks/${firstTankId}/dosing-settings`;
                } catch (err) {
                    return;
                }
                links.forEach((link) => {
                    const target = link.dataset.guideLink;
                    if (!target || !linkTargets[target]) return;
                    link.setAttribute("href", linkTargets[target]);
                });
            };

            tasks.forEach((task) => {
                const button = task.querySelector("[data-guide-complete]");
                if (!button) return;
                button.addEventListener("click", () => {
                    const id = task.dataset.guideTask;
                    if (!id) return;
                    state.completed[id] = !state.completed[id];
                    saveState(state);
                    updateUI();
                });
            });

            if (resetBtn) {
                resetBtn.addEventListener("click", () => {
                    state.completed = {};
                    state.seen = true;
                    saveState(state);
                    updateUI();
                });
            }

            const shouldShowOnDashboard = () => {
                if (window.location.pathname !== "/") return false;
                return getCompletedCount() < tasks.length;
            };

            const maybeShowModal = () => {
                if (!state.seen || shouldShowOnDashboard()) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                    state.seen = true;
                    saveState(state);
                }
            };

            modalEl.addEventListener("show.bs.modal", () => {
                state = loadState();
                updateUI();
                updateGuideLinks();
            });

            updateUI();
            maybeShowModal();
        });

        document.addEventListener("DOMContentLoaded", () => {
            const toggleButtons = Array.from(document.querySelectorAll(".js-enable-browser-alerts"));
            const getAnySubscription = async () => {
                if (!("serviceWorker" in navigator)) return null;
                try {
                    const registration = await navigator.serviceWorker.ready;
                    if (!registration?.pushManager) return null;
                    return await registration.pushManager.getSubscription();
                } catch (err) {
                    return null;
                }
            };
            const updateStatus = async () => {
                if (!("serviceWorker" in navigator)) {
                    toggleButtons.forEach((btn) => {
                        const targetId = btn.getAttribute("data-status-target");
                        const label = targetId ? document.getElementById(targetId) : null;
                        if (label) label.textContent = "Unsupported";
                        btn.disabled = true;
                    });
                    return;
                }
                try {
                    await navigator.serviceWorker.ready;
                } catch (err) {
                    // Ignore readiness errors and fall back to manual checks.
                }
                if (!("Notification" in window) || !("PushManager" in window)) {
                    toggleButtons.forEach((btn) => {
                        const targetId = btn.getAttribute("data-status-target");
                        const label = targetId ? document.getElementById(targetId) : null;
                        if (label) label.textContent = "Unsupported";
                        btn.disabled = true;
                    });
                    return;
                }
                const subscription = await getAnySubscription();
                const permission = Notification?.permission || "default";
                toggleButtons.forEach((btn) => {
                    const targetId = btn.getAttribute("data-status-target");
                    const label = targetId ? document.getElementById(targetId) : null;
                    if (label) {
                        if (subscription) {
                            label.textContent = "On";
                        } else if (permission === "denied") {
                            label.textContent = "Blocked";
                        } else {
                            label.textContent = "Off";
                        }
                    }
                });
            };
            const urlBase64ToUint8Array = (base64String) => {
                const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
                const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
                const rawData = atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; i += 1) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            };
            const getPublicKey = async () => {
                const response = await fetch("/api/push/public-key");
                if (!response.ok) return null;
                const data = await response.json();
                return data.public_key || null;
            };
            const subscribePush = async () => {
                if (!("serviceWorker" in navigator)) return;
                const publicKey = await getPublicKey();
                if (!publicKey) {
                    alert("Push notifications are not configured on the server.");
                    return null;
                }
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicKey),
                });
                await fetch("/api/push/subscribe", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-Token": window.csrfToken || "",
                    },
                    body: JSON.stringify(subscription),
                });
                return subscription;
            };
            const unsubscribePush = async () => {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    const subscription = await registration.pushManager.getSubscription();
                    if (!subscription) continue;
                    await fetch("/api/push/unsubscribe", {
                        method: "POST",
                        credentials: "same-origin",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRF-Token": window.csrfToken || "",
                        },
                        body: JSON.stringify({ endpoint: subscription.endpoint }),
                    });
                    await subscription.unsubscribe();
                }
            };
            toggleButtons.forEach((btn) => {
                btn.addEventListener("click", async () => {
                    if (!("Notification" in window)) {
                        alert("Browser notifications are not supported on this device.");
                        return;
                    }
                    const permission = await Notification.requestPermission();
                    if (permission !== "granted") {
                        await updateStatus();
                        return;
                    }
                    const subscription = await getAnySubscription();
                    if (subscription) {
                        await unsubscribePush();
                    } else {
                        const newSubscription = await subscribePush();
                        if (newSubscription) {
                            toggleButtons.forEach((button) => {
                                const targetId = button.getAttribute("data-status-target");
                                const label = targetId ? document.getElementById(targetId) : null;
                                if (label) label.textContent = "On";
                            });
                        }
                    }
                    await updateStatus();
                });
            });
            updateStatus();
        });

        document.addEventListener("DOMContentLoaded", () => {
            const testButtons = Array.from(document.querySelectorAll(".js-send-test-push"));
            if (!testButtons.length) return;
            testButtons.forEach((button) => {
                button.addEventListener("click", async () => {
                    if (!("Notification" in window) || !("serviceWorker" in navigator)) {
                        alert("Browser notifications are not supported on this device.");
                        return;
                    }
                    const permission = await Notification.requestPermission();
                    if (permission !== "granted") {
                        alert("Notifications are blocked for this device.");
                        return;
                    }
                    let subscription = null;
                    try {
                        const registration = await navigator.serviceWorker.ready;
                        subscription = await registration.pushManager.getSubscription();
                        if (!subscription) {
                            const response = await fetch("/api/push/public-key");
                            if (!response.ok) {
                                alert("Push notifications are not configured on the server.");
                                return;
                            }
                            const data = await response.json();
                            if (!data?.public_key) {
                                alert("Push notifications are not configured on the server.");
                                return;
                            }
                            const padding = "=".repeat((4 - (data.public_key.length % 4)) % 4);
                            const base64 = (data.public_key + padding).replace(/-/g, "+").replace(/_/g, "/");
                            const rawData = atob(base64);
                            const outputArray = new Uint8Array(rawData.length);
                            for (let i = 0; i < rawData.length; i += 1) {
                                outputArray[i] = rawData.charCodeAt(i);
                            }
                            subscription = await registration.pushManager.subscribe({
                                userVisibleOnly: true,
                                applicationServerKey: outputArray,
                            });
                            await fetch("/api/push/subscribe", {
                                method: "POST",
                                credentials: "same-origin",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRF-Token": window.csrfToken || "",
                                },
                                body: JSON.stringify(subscription),
                            });
                        }
                    } catch (err) {
                        alert("Unable to prepare a push subscription.");
                        return;
                    }
                    try {
                        const response = await fetch("/api/push/test", {
                            method: "POST",
                            credentials: "same-origin",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRF-Token": window.csrfToken || "",
                            },
                            body: JSON.stringify({
                                subscription,
                            }),
                        });
                        if (!response.ok) {
                            const data = await response.json().catch(() => ({}));
                            alert(data?.detail || "Unable to send test notification.");
                            return;
                        }
                        alert("Test notification sent!");
                    } catch (err) {
                        alert("Unable to send test notification.");
                    }
                });
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const tooltipTriggers = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggers.forEach((trigger) => {
                new bootstrap.Tooltip(trigger);
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const skeletons = Array.from(document.querySelectorAll("[data-skeleton]"));
            if (!skeletons.length) return;
            setTimeout(() => {
                skeletons.forEach((el) => el.removeAttribute("data-skeleton"));
            }, 200);
        });

        document.addEventListener("DOMContentLoaded", () => {
            const installBanner = document.getElementById("pwa-install-banner");
            const installBtn = document.getElementById("pwa-install-btn");
            const installDismiss = document.getElementById("pwa-install-dismiss");
            const iosBanner = document.getElementById("pwa-ios-banner");
            const iosDismiss = document.getElementById("pwa-ios-dismiss");
            let deferredPrompt = null;

            window.addEventListener("beforeinstallprompt", (event) => {
                event.preventDefault();
                deferredPrompt = event;
                if (installBanner) {
                    installBanner.classList.remove("d-none");
                }
            });

            if (installBtn) {
                installBtn.addEventListener("click", async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    installBanner?.classList.add("d-none");
                });
            }

            installDismiss?.addEventListener("click", () => {
                installBanner?.classList.add("d-none");
            });

            const isIos = /iphone|ipad|ipod/i.test(window.navigator.userAgent);
            const isStandalone = window.navigator.standalone === true;
            if (isIos && !isStandalone && iosBanner) {
                iosBanner.classList.remove("d-none");
            }
            iosDismiss?.addEventListener("click", () => {
                iosBanner?.classList.add("d-none");
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const shareButtons = Array.from(document.querySelectorAll("[data-share-url]"));
            shareButtons.forEach((btn) => {
                btn.addEventListener("click", async () => {
                    if (!navigator.share) {
                        alert("Sharing is not supported on this device.");
                        return;
                    }
                    const title = btn.getAttribute("data-share-title") || "Reef Metrics";
                    const text = btn.getAttribute("data-share-text") || "";
                    const url = btn.getAttribute("data-share-url") || window.location.href;
                    try {
                        await navigator.share({ title, text, url });
                    } catch (err) {
                        return;
                    }
                });
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const offlineBanner = document.getElementById("offline-banner");
            const retryButton = document.getElementById("offline-retry");
            const updateBanner = () => {
                if (!offlineBanner) return;
                if (navigator.onLine) {
                    offlineBanner.classList.add("d-none");
                } else {
                    offlineBanner.classList.remove("d-none");
                }
            };
            window.addEventListener("online", updateBanner);
            window.addEventListener("offline", updateBanner);
            retryButton?.addEventListener("click", () => {
                updateBanner();
                if (navigator.onLine) {
                    window.location.reload();
                }
            });
            updateBanner();
        });
    </script>
</body>
</html>
