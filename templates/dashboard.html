{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-0">Dashboard</h1>
    <div class="text-muted small">Latest readings per tank</div>
  </div>
  <a class="btn btn-outline-secondary btn-sm" href="/tanks/reorder">
    <i class="bi bi-arrow-down-up"></i> Reorder Tanks
  </a>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
  {% for c in tank_cards %}
    {% set t = c.tank %}
    {% set latest = c.latest %}
    {% set readings = c.readings if c.readings is defined else [] %}
    {% set ts = c.latest_time if c.latest_time is defined else (latest.taken_at if latest else None) %}
    {% set summary = c.summary if c.summary is defined else {} %}

    <div class="col">
      <div class="card h-100 shadow-sm border-0 position-relative card-hover">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between gap-2 mb-3">
            <div class="min-w-0">
              <h5 class="card-title mb-1 text-truncate fw-bold">
                  <a href="/tanks/{{ t.id if t.id is defined else t['id'] }}" class="text-decoration-none text-dark stretched-link">
                    {{ t.name if t.name is defined else t['name'] }}
                  </a>
              </h5>
              <div class="mt-2 d-flex flex-wrap gap-2">
                {% if summary.out_of_range %}
                  <span class="badge text-bg-warning">{{ summary.out_of_range }} out of range</span>
                {% else %}
                  <span class="badge text-bg-success">All in range</span>
                {% endif %}
                {% if summary.overdue %}
                  <span class="badge text-bg-info">{{ summary.overdue }} overdue</span>
                {% endif %}
                {% if summary.last_dose_at %}
                  <span class="badge bg-light text-secondary border">Last dose {{ summary.last_dose_at|time_ago }}</span>
                {% endif %}
              </div>
              <div class="small text-muted">
                  {% if ts %}
                    <span class="text-secondary">Last test: {{ ts|time_ago }}</span>
                  {% else %}
                    No logs yet
                  {% endif %}
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              {% set vol = (t.volume_l if t.volume_l is defined else t.get('volume_l')) %}
              {% if vol %}
                <span class="badge bg-light text-secondary border">{{ vol|fmt2 }} L</span>
              {% endif %}
            </div>
          </div>

          <div class="mt-3">
            {% if readings and readings|length > 0 %}
              <div class="d-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .5rem;">
                {% for r in readings %}
                  {% set status_class = "border-secondary-subtle" %}
                  {% if r.status == "danger" %}
                    {% set status_class = "border-danger bg-danger-subtle" %}
                  {% elif r.status == "warn" %}
                    {% set status_class = "border-warning bg-warning-subtle" %}
                  {% elif r.status == "ok" %}
                    {% set status_class = "border-success bg-success-subtle" %}
                  {% endif %}
                  <div class="border rounded-2 p-2 {{ status_class }}">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div class="small text-muted text-truncate" style="max-width: 65%;">
                            {{ r.name if r.name is defined else r['name'] }}
                        </div>
                        {% set r_taken = r.taken_at if r.taken_at is defined else r.get('taken_at') %}
                        {% if r_taken %}
                            <span class="badge bg-white text-secondary border fw-normal" style="font-size: 0.6rem;">
                                {{ r_taken|time_ago }}
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="fw-bold fs-5">
                      {% if r.value is defined %}
                        {{ r.value|fmt2 }}
                      {% else %}
                        {{ r['value']|fmt2 }}
                      {% endif %}
                      <span class="text-muted fw-normal fs-6">{{ (r.unit if r.unit is defined else r.get('unit')) or "" }}</span>
                    </div>
                    <div class="mt-1 d-flex flex-wrap gap-1">
                      {% if r.trend_warning %}
                        <span class="badge text-bg-warning">Rapid change</span>
                      {% endif %}
                      {% if r.overdue %}
                        <span class="badge text-bg-info">Overdue</span>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted small py-4 text-center fst-italic">No recent tests recorded.</div>
            {% endif %}
          </div>
        </div>

        <div class="card-footer bg-white border-top-0 pt-0 pb-3">
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a class="btn btn-primary btn-sm position-relative z-2" href="/tanks/{{ t.id if t.id is defined else t['id'] }}/add">Log Test</a>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <div class="col">
    <a href="/tanks/new" class="card h-100 shadow-sm border-0 text-decoration-none text-center d-flex align-items-center justify-content-center bg-light text-muted p-5 card-hover" style="min-height: 250px; border: 2px dashed #dee2e6 !important;">
        <div>
            <div class="display-4 mb-2">+</div>
            <div class="fw-medium">Add New Tank</div>
        </div>
    </a>
  </div>
</div>
{% endblock %}
