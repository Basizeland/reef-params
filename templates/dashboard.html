{% extends "base.html" %}

{% block content %}
{% set stats = namespace(readings=0, alerts=0) %}
{% for c in tank_cards %}
  {% if c.readings is defined and c.readings %}
    {% set stats.readings = stats.readings + (c.readings|length) %}
  {% endif %}
  {% set summary = c.summary if c.summary is defined else {} %}
  {% if summary.out_of_range %}
    {% set stats.alerts = stats.alerts + summary.out_of_range %}
  {% endif %}
{% endfor %}

<section class="reef-hero mb-4">
  <div class="row align-items-center gy-4 position-relative">
    <div class="col-lg-7">
      <div class="reef-eyebrow" data-skeleton>Reef Metrics</div>
      <h1 class="reef-heading" data-skeleton>Advanced analytics for your aquarium.</h1>
      <p class="reef-subtitle">
        Monitor water quality, spot trends, and stay ahead of dosing alerts with a calm, focused workspace.
      </p>
      <div class="d-flex flex-wrap gap-2 mt-3">
        <a class="btn btn-primary" href="/tanks/new">Add a new tank</a>
        <a class="btn btn-outline-secondary" href="/tools/calculators">Open dosing tools</a>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="reef-stat-grid">
        <div class="reef-stat">
          <div class="label">Active tanks</div>
          <div class="value">{{ tank_cards|length }}</div>
        </div>
        <div class="reef-stat">
          <div class="label">Latest readings</div>
          <div class="value">{{ stats.readings }}</div>
        </div>
        <div class="reef-stat">
          <div class="label">Alerts to review</div>
          <div class="value">{{ stats.alerts }}</div>
        </div>
      </div>
    </div>
  </div>
</section>

{% if reminders %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <div>
          <h2 class="h6 text-uppercase text-muted mb-1">Testing Reminders</h2>
          <div class="small text-muted">Parameters that are overdue for testing.</div>
        </div>
        <a class="btn btn-outline-secondary btn-sm" href="/insights">View insights</a>
      </div>
      <div class="row g-3">
        {% for item in reminders[:6] %}
          <div class="col-md-4">
            <a class="border rounded-3 p-3 h-100 bg-light text-decoration-none text-reset d-block" href="/tanks/{{ item.tank_id }}">
              <div class="fw-semibold">{{ item.parameter }}</div>
              <div class="small text-muted">
                {{ item.tank_name }} Â· Last test {{ item.last_tested|time_ago }}
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h2 class="h5 mb-1">Tank overview</h2>
    <div class="text-muted small">Latest readings per tank</div>
  </div>
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <div class="dropdown">
      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-sliders"></i> Customize cards
      </button>
      <div class="dropdown-menu p-3" style="min-width: 240px; max-height: 320px; overflow-y: auto;">
        <div class="small text-muted mb-2">Select up to 6 parameters</div>
        {% for p in available_params %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" data-dashboard-param-toggle value="{{ p.key }}" id="dash-param-{{ p.key }}">
            <label class="form-check-label small" for="dash-param-{{ p.key }}">{{ p.name }}</label>
          </div>
        {% endfor %}
      </div>
    </div>
    <a class="btn btn-outline-secondary btn-sm" href="/tanks/reorder">
      <i class="bi bi-arrow-down-up"></i> Reorder Tanks
    </a>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
  {% for c in tank_cards %}
    {% set t = c.tank %}
    {% set latest = c.latest %}
    {% set readings = c.readings if c.readings is defined else [] %}
    {% set ts = c.latest_time if c.latest_time is defined else (latest.taken_at if latest else None) %}
    {% set summary = c.summary if c.summary is defined else {} %}

    <div class="col">
      <div class="card h-100 shadow-sm border-0 position-relative card-hover" data-dashboard-card>
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between gap-2 mb-3">
            <div class="min-w-0">
              <h5 class="card-title mb-1 text-truncate fw-bold">
                  <a href="/tanks/{{ t.id if t.id is defined else t['id'] }}" class="text-decoration-none text-dark stretched-link">
                    {{ t.name if t.name is defined else t['name'] }}
                  </a>
              </h5>
              <div class="mt-2 d-flex flex-wrap gap-2">
                {% if summary.out_of_range %}
                  <span class="badge text-bg-warning">{{ summary.out_of_range }} out of range</span>
                {% else %}
                  <span class="badge text-bg-success">All in range</span>
                {% endif %}
                {% if summary.overdue %}
                  <span class="badge text-bg-info">{{ summary.overdue }} overdue</span>
                {% endif %}
                {% if summary.last_dose_at %}
                  <span class="badge bg-light text-secondary border">Last dose {{ summary.last_dose_at|time_ago }}</span>
                {% endif %}
              </div>
              <div class="small text-muted">
                  {% if ts %}
                    <span class="text-secondary">Last test: {{ ts|time_ago }}</span>
                  {% else %}
                    No logs yet
                  {% endif %}
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              {% set vol = (t.volume_l if t.volume_l is defined else t.get('volume_l')) %}
              {% if vol %}
                <span class="badge bg-light text-secondary border">{{ vol|fmt2 }} L</span>
              {% endif %}
            </div>
          </div>

          <div class="mt-3">
            {% if readings and readings|length > 0 %}
              <div class="d-grid" data-dashboard-param-grid style="grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .5rem;">
                {% for r in readings %}
                  {% set status_class = "border-secondary-subtle" %}
                  {% if r.status == "danger" %}
                    {% set status_class = "border-danger bg-danger-subtle" %}
                  {% elif r.status == "warn" %}
                    {% set status_class = "border-warning bg-warning-subtle" %}
                  {% elif r.status == "ok" %}
                    {% set status_class = "border-success bg-success-subtle" %}
                  {% endif %}
                  <div class="border rounded-2 p-2 {{ status_class }}" data-dashboard-param="{{ r.key }}">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div class="small text-muted text-truncate" style="max-width: 65%;">
                            {{ r.name if r.name is defined else r['name'] }}
                        </div>
                        {% set r_taken = r.taken_at if r.taken_at is defined else r.get('taken_at') %}
                        {% if r_taken %}
                            <span class="badge bg-white text-secondary border fw-normal" style="font-size: 0.6rem;">
                                {{ r_taken|time_ago }}
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="fw-bold fs-5">
                      {% if r.value is defined %}
                        {{ r.value|fmt2 }}
                      {% else %}
                        {{ r['value']|fmt2 }}
                      {% endif %}
                      <span class="text-muted fw-normal fs-6">{{ (r.unit if r.unit is defined else r.get('unit')) or "" }}</span>
                    </div>
                    {% set sparkline = r.sparkline if r.sparkline is defined else "" %}
                    {% if sparkline %}
                      <div class="mt-2 sparkline">
                        <svg viewBox="0 0 84 24" width="84" height="24" aria-hidden="true" focusable="false">
                          <polyline fill="none" stroke="currentColor" stroke-width="2" points="{{ sparkline }}"></polyline>
                        </svg>
                      </div>
                    {% endif %}
                    <div class="mt-1 d-flex flex-wrap gap-1">
                      {% if r.trend_warning %}
                        <span class="badge text-bg-warning">Rapid change</span>
                      {% endif %}
                      {% if r.overdue %}
                        <span class="badge text-bg-info">Overdue</span>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
              <div class="text-muted small py-3 text-center fst-italic d-none" data-dashboard-empty>
                Select parameters above to display on cards.
              </div>
            {% else %}
              <div class="text-muted small py-4 text-center fst-italic">No recent tests recorded.</div>
            {% endif %}
          </div>
        </div>

        <div class="card-footer bg-white border-top-0 pt-0 pb-3">
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a class="btn btn-primary btn-sm position-relative z-2" href="/tanks/{{ t.id if t.id is defined else t['id'] }}/add">Log Test</a>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <div class="col">
    <a href="/tanks/new" class="card h-100 text-decoration-none text-center d-flex align-items-center justify-content-center p-5 card-hover reef-add-card">
        <div>
            <div class="display-4 mb-2">+</div>
            <div class="fw-medium">Add New Tank</div>
            <div class="small text-muted">Start tracking a new aquarium.</div>
        </div>
    </a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const storageKey = 'reef-dashboard-params';
    const maxSelected = 6;
    const toggles = Array.from(document.querySelectorAll('[data-dashboard-param-toggle]'));
    const tiles = Array.from(document.querySelectorAll('[data-dashboard-param]'));
    const cards = Array.from(document.querySelectorAll('[data-dashboard-card]'));

    if (!toggles.length || !tiles.length) {
      return;
    }

    const readStored = () => {
      try {
        const raw = window.localStorage.getItem(storageKey);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        return [];
      }
    };

    const setSelection = (selected) => {
      const selectedSet = new Set(selected);
      toggles.forEach((toggle) => {
        toggle.checked = selectedSet.has(toggle.value);
      });
      tiles.forEach((tile) => {
        tile.classList.toggle('d-none', !selectedSet.has(tile.dataset.dashboardParam));
      });
      cards.forEach((card) => {
        const visibleTiles = card.querySelectorAll('[data-dashboard-param]:not(.d-none)');
        const emptyState = card.querySelector('[data-dashboard-empty]');
        if (emptyState) {
          emptyState.classList.toggle('d-none', visibleTiles.length > 0);
        }
      });
    };

    const saveSelection = (selected) => {
      try {
        window.localStorage.setItem(storageKey, JSON.stringify(selected));
      } catch (err) {
        // ignore
      }
    };

    let selected = readStored();
    const validKeys = new Set(toggles.map((toggle) => toggle.value));
    selected = selected.filter((key) => validKeys.has(key));
    if (!selected.length) {
      selected = toggles.slice(0, maxSelected).map((toggle) => toggle.value);
    }
    setSelection(selected);
    saveSelection(selected);

    toggles.forEach((toggle) => {
      toggle.addEventListener('change', (event) => {
        const checked = toggles.filter((item) => item.checked);
        if (checked.length > maxSelected) {
          event.target.checked = false;
        }
        const next = toggles.filter((item) => item.checked).map((item) => item.value);
        setSelection(next);
        saveSelection(next);
      });
    });
  });
</script>
{% endblock %}
