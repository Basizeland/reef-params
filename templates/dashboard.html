{% extends "base.html" %}

{% block content %}
{% set stats = namespace(readings=0, alerts=0) %}
{% for c in tank_cards %}
  {% if c.readings is defined and c.readings %}
    {% set stats.readings = stats.readings + (c.readings|length) %}
  {% endif %}
  {% set summary = c.summary if c.summary is defined else {} %}
  {% if summary.out_of_range %}
    {% set stats.alerts = stats.alerts + summary.out_of_range %}
  {% endif %}
{% endfor %}

<section class="reef-hero-enhanced mb-5">
  <div class="hero-background-effect"></div>
  <div class="row align-items-center gy-4 position-relative">
    <div class="col-lg-7">
      <div class="hero-content">
        <div class="reef-eyebrow animate-fade-in" data-skeleton>
          <i class="bi bi-water"></i> Reef Metrics
        </div>
        <h1 class="reef-heading-enhanced animate-slide-up" data-skeleton>
          Advanced analytics for your aquarium.
        </h1>
        <p class="reef-subtitle-enhanced animate-slide-up" style="animation-delay: 0.1s;">
          Monitor water quality, spot trends, and stay ahead of dosing alerts with a calm, focused workspace designed for reef enthusiasts.
        </p>
        <div class="d-flex flex-wrap gap-3 mt-4 animate-slide-up" style="animation-delay: 0.2s;">
          <a class="btn btn-primary btn-enhanced" href="/tanks/new">
            <i class="bi bi-plus-circle me-2"></i>Add a new tank
          </a>
          <a class="btn btn-outline-secondary btn-enhanced" href="/tools/calculators">
            <i class="bi bi-calculator me-2"></i>Open dosing tools
          </a>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="reef-stat-grid-enhanced">
        <div class="reef-stat-enhanced animate-scale" style="animation-delay: 0.1s;">
          <div class="stat-icon">
            <i class="bi bi-droplet-fill"></i>
          </div>
          <div class="stat-content">
            <div class="label">Active tanks</div>
            <div class="value">{{ tank_cards|length }}</div>
          </div>
        </div>
        <div class="reef-stat-enhanced animate-scale" style="animation-delay: 0.2s;">
          <div class="stat-icon stat-icon-success">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <div class="stat-content">
            <div class="label">Latest readings</div>
            <div class="value">{{ stats.readings }}</div>
          </div>
        </div>
        <div class="reef-stat-enhanced animate-scale" style="animation-delay: 0.3s;">
          <div class="stat-icon {% if stats.alerts > 0 %}stat-icon-warning{% endif %}">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <div class="stat-content">
            <div class="label">Alerts to review</div>
            <div class="value {% if stats.alerts > 0 %}text-warning-emphasis{% endif %}">{{ stats.alerts }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% if reminders %}
  <div class="card reminder-card-enhanced shadow-sm border-0 mb-5 animate-slide-up">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
        <div>
          <h2 class="h5 mb-2 d-flex align-items-center gap-2">
            <i class="bi bi-clock-history text-primary"></i>
            Testing Reminders
          </h2>
          <div class="text-muted">Parameters that are overdue for testing.</div>
        </div>
        <a class="btn btn-outline-secondary btn-sm" href="/insights">
          <i class="bi bi-graph-up me-1"></i>View insights
        </a>
      </div>
      <div class="row g-3">
        {% for item in reminders[:6] %}
          <div class="col-md-4 col-sm-6">
            <a class="reminder-item-enhanced text-decoration-none text-reset d-block h-100" href="/tanks/{{ item.tank_id }}">
              <div class="reminder-icon">
                <i class="bi bi-flask"></i>
              </div>
              <div class="reminder-content">
                <div class="fw-semibold text-navy mb-1">{{ item.parameter }}</div>
                <div class="small text-muted">
                  <i class="bi bi-droplet me-1"></i>{{ item.tank_name }}
                </div>
                <div class="small text-muted mt-1">
                  <i class="bi bi-clock me-1"></i>Last test {{ item.last_tested|time_ago }}
                </div>
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

<div class="d-flex align-items-center justify-content-between mb-4 tank-header-enhanced">
  <div>
    <h2 class="h4 mb-2 d-flex align-items-center gap-2">
      <i class="bi bi-grid-3x3-gap text-primary"></i>
      Tank overview
    </h2>
    <div class="text-muted">Latest readings and status for all your aquariums</div>
  </div>
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <div class="dropdown">
      <button class="btn btn-outline-secondary btn-sm btn-enhanced dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-sliders"></i> Customize
      </button>
      <div class="dropdown-menu dropdown-menu-enhanced p-3" style="min-width: 260px; max-height: 380px; overflow-y: auto;">
        <div class="small text-muted mb-3 fw-semibold">
          <i class="bi bi-toggles me-1"></i>Select up to 6 parameters
        </div>
        {% for p in available_params %}
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" data-dashboard-param-toggle value="{{ p.key }}" id="dash-param-{{ p.key }}">
            <label class="form-check-label" for="dash-param-{{ p.key }}">{{ p.name }}</label>
          </div>
        {% endfor %}
      </div>
    </div>
    <a class="btn btn-outline-secondary btn-sm btn-enhanced" href="/tanks/reorder">
      <i class="bi bi-arrow-down-up"></i> Reorder
    </a>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
  {% for c in tank_cards %}
    {% set t = c.tank %}
    {% set latest = c.latest %}
    {% set readings = c.readings if c.readings is defined else [] %}
    {% set ts = c.latest_time if c.latest_time is defined else (latest.taken_at if latest else None) %}
    {% set summary = c.summary if c.summary is defined else {} %}

    <div class="col">
      <div class="card tank-card-enhanced h-100 shadow-sm border-0 position-relative" data-dashboard-card>
        <div class="tank-card-glow"></div>
        <div class="card-body p-4">
          <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
            <div class="min-w-0 flex-grow-1">
              <h5 class="card-title mb-2 d-flex align-items-center gap-2">
                  <i class="bi bi-droplet-fill text-primary tank-icon"></i>
                  <a href="/tanks/{{ t.id if t.id is defined else t['id'] }}" class="text-decoration-none text-dark stretched-link tank-title-link">
                    {{ t.name if t.name is defined else t['name'] }}
                  </a>
              </h5>
              <div class="mt-2 d-flex flex-wrap gap-2">
                {% if summary.out_of_range %}
                  <span class="badge badge-enhanced badge-warning">
                    <i class="bi bi-exclamation-circle me-1"></i>{{ summary.out_of_range }} out of range
                  </span>
                {% else %}
                  <span class="badge badge-enhanced badge-success">
                    <i class="bi bi-check-circle me-1"></i>All in range
                  </span>
                {% endif %}
                {% if summary.overdue %}
                  <span class="badge badge-enhanced badge-info">
                    <i class="bi bi-clock me-1"></i>{{ summary.overdue }} overdue
                  </span>
                {% endif %}
                {% if summary.last_dose_at %}
                  <span class="badge badge-enhanced badge-light">
                    <i class="bi bi-eyedropper me-1"></i>Dosed {{ summary.last_dose_at|time_ago }}
                  </span>
                {% endif %}
              </div>
              <div class="small text-muted mt-2 d-flex align-items-center gap-1">
                  {% if ts %}
                    <i class="bi bi-clock-history"></i>
                    <span>Last test {{ ts|time_ago }}</span>
                  {% else %}
                    <i class="bi bi-info-circle"></i>
                    <span>No logs yet</span>
                  {% endif %}
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              {% set vol = (t.volume_l if t.volume_l is defined else t.get('volume_l')) %}
              {% if vol %}
                <div class="volume-badge-enhanced">
                  <div class="volume-value">{{ vol|fmt2 }}</div>
                  <div class="volume-unit">Liters</div>
                </div>
              {% endif %}
            </div>
          </div>

          <div class="mt-3">
            {% if readings and readings|length > 0 %}
              <div class="d-grid param-grid-enhanced" data-dashboard-param-grid style="grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .75rem;">
                {% for r in readings %}
                  {% set status_class = "param-tile-neutral" %}
                  {% set status_icon = "bi-dash-circle" %}
                  {% if r.status == "danger" %}
                    {% set status_class = "param-tile-danger" %}
                    {% set status_icon = "bi-exclamation-circle-fill" %}
                  {% elif r.status == "warn" %}
                    {% set status_class = "param-tile-warning" %}
                    {% set status_icon = "bi-exclamation-triangle-fill" %}
                  {% elif r.status == "ok" %}
                    {% set status_class = "param-tile-success" %}
                    {% set status_icon = "bi-check-circle-fill" %}
                  {% endif %}
                  <div class="param-tile-enhanced {{ status_class }}" data-dashboard-param="{{ r.key }}">
                    <div class="param-tile-header">
                        <div class="param-name">
                            <i class="{{ status_icon }} param-status-icon"></i>
                            {{ r.name if r.name is defined else r['name'] }}
                        </div>
                        {% set r_taken = r.taken_at if r.taken_at is defined else r.get('taken_at') %}
                        {% if r_taken %}
                            <span class="param-time-badge">
                                {{ r_taken|time_ago }}
                            </span>
                        {% endif %}
                    </div>

                    <div class="param-value-container">
                      <span class="param-value">
                        {% if r.value is defined %}
                          {{ r.value|fmt2 }}
                        {% else %}
                          {{ r['value']|fmt2 }}
                        {% endif %}
                      </span>
                      <span class="param-unit">{{ (r.unit if r.unit is defined else r.get('unit')) or "" }}</span>
                    </div>

                    {% set sparkline = r.sparkline if r.sparkline is defined else "" %}
                    {% if sparkline %}
                      <div class="param-sparkline">
                        <svg viewBox="0 0 84 24" width="100%" height="24" aria-hidden="true" focusable="false">
                          <polyline fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="{{ sparkline }}"></polyline>
                        </svg>
                      </div>
                    {% endif %}

                    <div class="param-badges">
                      {% if r.trend_warning %}
                        <span class="badge badge-enhanced badge-warning-sm">
                          <i class="bi bi-arrow-up-right"></i>Rapid change
                        </span>
                      {% endif %}
                      {% if r.overdue %}
                        <span class="badge badge-enhanced badge-info-sm">
                          <i class="bi bi-clock"></i>Overdue
                        </span>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
              <div class="text-muted small py-3 text-center fst-italic d-none" data-dashboard-empty>
                <i class="bi bi-info-circle me-1"></i>Select parameters above to display on cards.
              </div>
            {% else %}
              <div class="empty-state-enhanced text-center py-4">
                <i class="bi bi-clipboard-x display-6 text-muted mb-2"></i>
                <div class="text-muted">No recent tests recorded.</div>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="card-footer bg-transparent border-top-0 pt-0 pb-3">
          <div class="d-grid">
            <a class="btn btn-primary btn-enhanced position-relative z-2" href="/tanks/{{ t.id if t.id is defined else t['id'] }}/add">
              <i class="bi bi-plus-circle me-2"></i>Log Test
            </a>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <div class="col">
    <a href="/tanks/new" class="card add-tank-card-enhanced h-100 text-decoration-none text-center d-flex align-items-center justify-content-center p-5">
        <div class="add-tank-content">
            <div class="add-tank-icon mb-3">
              <i class="bi bi-plus-circle"></i>
            </div>
            <div class="fw-semibold fs-5 mb-2">Add New Tank</div>
            <div class="text-muted">Start tracking a new aquarium</div>
        </div>
    </a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const storageKey = 'reef-dashboard-params';
    const maxSelected = 6;
    const toggles = Array.from(document.querySelectorAll('[data-dashboard-param-toggle]'));
    const tiles = Array.from(document.querySelectorAll('[data-dashboard-param]'));
    const cards = Array.from(document.querySelectorAll('[data-dashboard-card]'));

    if (!toggles.length || !tiles.length) {
      return;
    }

    const readStored = () => {
      try {
        const raw = window.localStorage.getItem(storageKey);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        return [];
      }
    };

    const setSelection = (selected) => {
      const selectedSet = new Set(selected);
      toggles.forEach((toggle) => {
        toggle.checked = selectedSet.has(toggle.value);
      });
      tiles.forEach((tile) => {
        tile.classList.toggle('d-none', !selectedSet.has(tile.dataset.dashboardParam));
      });
      cards.forEach((card) => {
        const visibleTiles = card.querySelectorAll('[data-dashboard-param]:not(.d-none)');
        const emptyState = card.querySelector('[data-dashboard-empty]');
        if (emptyState) {
          emptyState.classList.toggle('d-none', visibleTiles.length > 0);
        }
      });
    };

    const saveSelection = (selected) => {
      try {
        window.localStorage.setItem(storageKey, JSON.stringify(selected));
      } catch (err) {
        // ignore
      }
    };

    let selected = readStored();
    const validKeys = new Set(toggles.map((toggle) => toggle.value));
    selected = selected.filter((key) => validKeys.has(key));
    if (!selected.length) {
      selected = toggles.slice(0, maxSelected).map((toggle) => toggle.value);
    }
    setSelection(selected);
    saveSelection(selected);

    toggles.forEach((toggle) => {
      toggle.addEventListener('change', (event) => {
        const checked = toggles.filter((item) => item.checked);
        if (checked.length > maxSelected) {
          event.target.checked = false;
        }
        const next = toggles.filter((item) => item.checked).map((item) => item.value);
        setSelection(next);
        saveSelection(next);
      });
    });
  });
</script>
{% endblock %}
