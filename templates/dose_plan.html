{% extends "base.html" %}
{% block content %}
<style>
  .dose-plan-focus {
    border: 2px solid rgba(13, 110, 253, 0.35);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
  }
</style>
<div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-4">
  <div>
    <h1 class="display-6 fw-bold mb-1">Dose plan</h1>
    <div class="text-secondary">Based on most recent test results and your targets.</div>
  </div>
  <div class="d-flex align-items-center gap-2">
    <span class="badge rounded-pill bg-light text-dark border" id="grand-total-badge">
      Total across tanks: {{ grand_total_ml|fmt2 }} ml
    </span>
  </div>
</div>
<div id="dose-plan-focus-banner" class="alert alert-primary d-none align-items-center justify-content-between flex-wrap gap-2">
  <div>
    <div class="fw-semibold">Focused dose plan</div>
    <div class="small text-primary-emphasis" id="dose-plan-focus-text">Showing the highlighted parameter.</div>
  </div>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-outline-primary btn-sm" id="dose-plan-jump">Jump to focus</button>
    <a class="btn btn-primary btn-sm" href="/tools/dose-plan">Clear focus</a>
  </div>
</div>
<div class="d-flex flex-wrap gap-2 align-items-center mb-4">
  <div class="me-auto d-flex flex-wrap gap-2 align-items-center">
    <label class="small text-muted">Jump to:</label>
    <select class="form-select form-select-sm w-auto" id="jump-tank">
      <option value="">Tank</option>
      {% for t in available_tanks %}
        <option value="{{ t.id }}">{{ t.name }}</option>
      {% endfor %}
    </select>
    <select class="form-select form-select-sm w-auto" id="jump-parameter">
      <option value="">Parameter</option>
      {% for param in available_parameters %}
        <option value="{{ param|lower }}">{{ param }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-outline-secondary btn-sm" type="button" id="jump-apply">Jump</button>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <span class="badge bg-light text-dark border">Parameters needing dose: {{ dose_plan_summary.parameters_needing_dose }}</span>
    {% if dose_plan_summary.top_deficit %}
      <span class="badge bg-primary-subtle text-primary-emphasis border">
        Top deficit: {{ dose_plan_summary.top_deficit.parameter }} +{{ dose_plan_summary.top_deficit.delta|fmt2 }} {{ dose_plan_summary.top_deficit.unit }}
      </span>
    {% endif %}
  </div>
</div>

{% if plans and plans|length %}
  {% for plan in plans %}
    <div class="card shadow-sm mb-4 tank-wrapper" data-tank-id="{{ plan.tank['id'] }}">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3 border-bottom pb-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <h2 class="h4 fw-bold mb-0">{{ plan.tank["name"] }}</h2>
            <a class="btn btn-sm btn-outline-secondary" href="/tanks/{{ plan.tank['id'] }}">View Tank</a>
          </div>
          <div class="text-secondary small">
            <span class="me-2">Vol: {{ plan.eff_vol_l|default(0)|round(0) }} L</span>
            <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill tank-total">Total: 0.00 ml</span>
          </div>
        </div>

        {% if plan.rows and plan.rows|length %}
          
          <div class="table-responsive d-none d-lg-block">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 25%;">Additive</th>
                  <th style="width: 15%;">Parameter</th>
                  <th class="text-end" style="width: 10%;">Current</th>
                  <th class="text-end" style="width: 10%;">Target</th>
                  <th style="width: 25%;">Schedule</th>
                  <th class="text-center" style="width: 15%;">Dosed</th>
                </tr>
              </thead>
              <tbody>
                {% for r in plan.rows %}
                  {% if r.additives and r.additives|length > 0 %}
                    <tr data-parameter="{{ r.parameter|lower }}" data-tank-id="{{ plan.tank['id'] }}">
                      <td>
                        <select class="form-select form-select-sm additive-select desktop-select" 
                                data-sync-key="{{ plan.tank['id'] }}-{{ r.parameter }}"
                                onchange="handleSelectionChange(this)">
                          {% for a in r.additives %}
                            <option value="{{ a.additive_id }}" 
                                    data-ml="{{ a.total_ml }}" 
                                    {% if a.selected %}selected{% endif %}>
                                {{ a.additive_name }}
                            </option>
                          {% endfor %}
                        </select>
                      </td>
                      
                      <td><span class="badge bg-light text-secondary border fw-normal">{{ r.parameter }}</span></td>
                      <td class="text-end">{{ r.latest|fmt2 }} <small class="text-muted">{{ r.unit }}</small></td>
                      <td class="text-end">{{ r.target|fmt2 }} <small class="text-muted">{{ r.unit }}</small></td>
                      
                      <td>
                        {% for a in r.additives %}
                          <div class="dose-schedule-container {% if not a.selected %}d-none{% endif %}" data-additive-id="{{ a.additive_id }}">
                            {% if a.schedule and a.schedule|length %}
                              <div class="small text-secondary mb-1">
                                {{ a.schedule|length }} day(s) • <span class="fw-bold">{{ a.total_ml|fmt2 }} ml</span> total
                              </div>
                              <div class="d-flex flex-wrap gap-1">
                                {% for s in a.schedule %}
                                  <span class="badge bg-light text-dark border fw-normal">
                                    D{{ s.day }}: {{ s.ml|fmt2 }}ml
                                  </span>
                                {% endfor %}
                              </div>
                            {% else %}
                              <span class="text-secondary small">—</span>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </td>

                      <td class="text-center">
                        {% for a in r.additives %}
                          <div class="dose-check-container d-flex flex-column gap-1 align-items-center {% if not a.selected %}d-none{% endif %}" data-additive-id="{{ a.additive_id }}">
                            {% if a.schedule and a.schedule|length %}
                                {% for s in a.schedule %}
                                  <label class="form-check form-check-inline m-0 pointer" style="cursor: pointer;">
                                    <input class="form-check-input dose-check"
                                           type="checkbox"
                                           data-tank-id="{{ plan.tank['id'] }}"
                                           data-additive-id="{{ a.additive_id }}"
                                           data-parameter="{{ r.parameter }}"
                                           data-planned-date="{{ s.date }}"
                                           data-amount-ml="{{ s.ml }}"
                                           {% if s.checked %}checked{% endif %}>
                                    <span class="form-check-label small user-select-none {% if s.checked %}text-decoration-line-through text-muted{% endif %}">Day {{ s.day }}</span>
                                  </label>
                                {% endfor %}
                            {% else %}
                              <span class="text-secondary small">—</span>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="6" class="text-muted small">
                        No additive configured for {{ r.parameter }}.
                        <a href="/additives/new?parameter={{ r.parameter|replace(' ', '%20') }}" class="ms-1">Create additive</a>
                        {% if r.suggested_additive %}
                          <span class="ms-2">Suggested: {{ r.suggested_additive.name }}</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="d-lg-none">
            {% for r in plan.rows %}
              {% if r.additives and r.additives|length > 0 %}
                <div class="card mb-3 bg-light bg-opacity-25 border additive-card-group" data-parameter="{{ r.parameter|lower }}" data-tank-id="{{ plan.tank['id'] }}">
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2 gap-2">
                      <div class="w-100">
                        <div class="small text-muted mb-1">{{ r.parameter }}</div>
                        <select class="form-select form-select-sm w-100 additive-select mobile-select" 
                                data-sync-key="{{ plan.tank['id'] }}-{{ r.parameter }}"
                                onchange="handleSelectionChange(this)">
                          {% for a in r.additives %}
                            <option value="{{ a.additive_id }}" 
                                    data-ml="{{ a.total_ml }}"
                                    {% if a.selected %}selected{% endif %}>
                                {{ a.additive_name }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center bg-white border rounded p-2 mb-3">
                      <div class="text-center w-50 border-end">
                        <div class="text-muted" style="font-size: 0.7rem;">CURRENT</div>
                        <div class="fw-medium">{{ r.latest|fmt2 }} {{ r.unit }}</div>
                      </div>
                      <div class="text-center w-50">
                        <div class="text-muted" style="font-size: 0.7rem;">TARGET</div>
                        <div class="fw-medium">{{ r.target|fmt2 }} {{ r.unit }}</div>
                      </div>
                    </div>

                    {% for a in r.additives %}
                      <div class="dose-mobile-container {% if not a.selected %}d-none{% endif %}" data-additive-id="{{ a.additive_id }}">
                        {% if a.schedule and a.schedule|length %}
                          <h6 class="small fw-bold text-muted mb-2 text-uppercase d-flex justify-content-between">
                             <span>Schedule</span>
                             <span>Total: {{ a.total_ml|fmt2 }} ml</span>
                          </h6>
                          <div class="d-flex flex-column gap-2">
                            {% for s in a.schedule %}
                              <label class="d-flex align-items-center justify-content-between p-2 rounded border bg-white" style="cursor: pointer;">
                                 <div class="d-flex align-items-center gap-2">
                                    <input class="form-check-input fs-5 m-0 dose-check"
                                           type="checkbox"
                                           data-tank-id="{{ plan.tank['id'] }}"
                                           data-additive-id="{{ a.additive_id }}"
                                           data-parameter="{{ r.parameter }}"
                                           data-planned-date="{{ s.date }}"
                                           data-amount-ml="{{ s.ml }}"
                                           {% if s.checked %}checked{% endif %}>
                                    <span class="fw-medium {% if s.checked %}text-decoration-line-through text-muted{% endif %}">Day {{ s.day }}</span>
                                 </div>
                                 <span class="badge bg-light text-dark border">{{ s.ml|fmt2 }} ml</span>
                              </label>
                            {% endfor %}
                          </div>
                        {% else %}
                          <div class="text-center text-muted small fst-italic py-2">No dosing required</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% else %}
                <div class="card mb-3 bg-light bg-opacity-25 border">
                  <div class="card-body p-3">
                    <div class="small text-muted mb-2">{{ r.parameter }}</div>
                    <div class="text-muted small">
                      No additive configured for {{ r.parameter }}.
                      <a href="/additives/new?parameter={{ r.parameter|replace(' ', '%20') }}" class="ms-1">Create additive</a>
                      {% if r.suggested_additive %}
                        <span class="ms-2">Suggested: {{ r.suggested_additive.name }}</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>

          {% if plan.icp_recommendations and plan.icp_recommendations|length %}
            <div class="border-top pt-3 mt-3">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <h6 class="mb-0 fw-semibold">ICP Dose Recommendations</h6>
                  {% if plan.icp_sample and plan.icp_sample.taken_at %}
                    <span class="badge bg-light text-secondary border">From {{ plan.icp_sample.taken_at|time_ago }}</span>
                  {% endif %}
                </div>
                <a class="btn btn-outline-secondary btn-sm" href="/tools/icp">View ICP Import</a>
              </div>
              <div class="table-responsive d-none d-lg-block">
                <table class="table align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 25%;">Additive</th>
                      <th style="width: 20%;">Current</th>
                      <th style="width: 20%;">Target</th>
                      <th style="width: 25%;">Schedule</th>
                      <th class="text-center" style="width: 10%;">Dosed</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for rec in plan.icp_recommendations %}
                      <tr>
                        <td>
                          <select class="form-select form-select-sm">
                            <option value="">Select additive</option>
                            {% for additive in rec.additives %}
                              <option value="{{ additive.id }}" {% if rec.selected_additive_id == additive.id %}selected{% endif %}>{{ additive.name }}</option>
                            {% endfor %}
                          </select>
                        </td>
                        <td>
                          {% if rec.current is not none %}
                            {{ rec.current|fmt2 }} {{ rec.target_unit or "" }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td>
                          {% if rec.target_low is not none and rec.target_high is not none %}
                            {{ rec.target_low|fmt2 }} - {{ rec.target_high|fmt2 }} {{ rec.target_unit or "" }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td>
                          {% if rec.value is not none %}
                            <div class="small text-secondary mb-1">
                              {{ rec.days }} day(s) • <span class="fw-bold">{{ rec.value|fmt2 }} {{ rec.unit or "" }}</span> total
                            </div>
                            <div class="d-flex flex-wrap gap-1">
                              {% for day in range(rec.days) %}
                                <span class="badge bg-light text-dark border fw-normal">
                                  D{{ day + 1 }}: {{ rec.per_day_value|fmt2 if rec.per_day_value is not none else rec.value|fmt2 }} {{ rec.unit or "" }}
                                </span>
                              {% endfor %}
                            </div>
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td class="text-center">
                          <label class="form-check form-check-inline m-0 pointer" style="cursor: pointer;">
                            <input class="form-check-input icp-dose-check"
                                   type="checkbox"
                                   data-sample-id="{{ rec.sample_id }}"
                                   data-label="{{ rec.label }}"
                                   {% if rec.checked %}checked{% endif %}>
                          </label>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="d-lg-none">
                {% for rec in plan.icp_recommendations %}
                  <div class="card mb-3 bg-light bg-opacity-25 border">
                    <div class="card-body p-3">
                      <div class="d-flex justify-content-between align-items-start gap-2">
                        <div>
                          <div class="small text-muted mb-1">Additive</div>
                          <select class="form-select form-select-sm">
                            <option value="">Select additive</option>
                            {% for additive in rec.additives %}
                              <option value="{{ additive.id }}" {% if rec.selected_additive_id == additive.id %}selected{% endif %}>{{ additive.name }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <label class="form-check m-0">
                          <input class="form-check-input icp-dose-check"
                                 type="checkbox"
                                 data-sample-id="{{ rec.sample_id }}"
                                 data-label="{{ rec.label }}"
                                 {% if rec.checked %}checked{% endif %}>
                        </label>
                      </div>
                      <div class="mt-3 d-flex justify-content-between align-items-center bg-white border rounded p-2">
                        <div class="text-muted" style="font-size: 0.7rem;">CURRENT</div>
                        <div class="fw-medium">
                          {% if rec.current is not none %}
                            {{ rec.current|fmt2 }} {{ rec.target_unit or "" }}
                          {% else %}
                            —
                          {% endif %}
                        </div>
                      </div>
                      <div class="mt-2 d-flex justify-content-between align-items-center bg-white border rounded p-2">
                        <div class="text-muted" style="font-size: 0.7rem;">TARGET</div>
                        <div class="fw-medium">
                          {% if rec.target_low is not none and rec.target_high is not none %}
                            {{ rec.target_low|fmt2 }} - {{ rec.target_high|fmt2 }} {{ rec.target_unit or "" }}
                          {% else %}
                            —
                          {% endif %}
                        </div>
                      </div>
                      <div class="mt-2">
                        <div class="small text-muted mb-1">Schedule</div>
                        {% if rec.value is not none %}
                          <div class="d-flex flex-column gap-1">
                            {% for day in range(rec.days) %}
                              <span class="badge bg-light text-dark border fw-normal">
                                Day {{ day + 1 }}: {{ rec.per_day_value|fmt2 if rec.per_day_value is not none else rec.value|fmt2 }} {{ rec.unit or "" }}
                              </span>
                            {% endfor %}
                          </div>
                        {% else %}
                          <div class="text-muted small">—</div>
                        {% endif %}
                      </div>
                      <div class="text-muted small mt-2">{{ rec.notes or "—" }}</div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

        {% else %}
          <div class="text-center py-4 text-muted">All parameters are within target range.</div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-light border shadow-sm text-center py-5">
    <h4 class="alert-heading h5">No Dose Plans Available</h4>
    <p class="mb-0 text-muted">Ensure you have created tanks, set targets, and logged recent test results.</p>
  </div>
{% endif %}

<script>
// 1. Initialization logic (Runs on page load)
document.addEventListener('DOMContentLoaded', function() {
    // A. Restore preferences from Local Storage
    document.querySelectorAll('.additive-select').forEach(select => {
        const syncKey = select.dataset.syncKey; // e.g. "1-Magnesium"
        const savedId = localStorage.getItem('dose_pref_' + syncKey);
        
        // If we have a saved preference, and that option still exists in the dropdown
        if (savedId && select.querySelector(`option[value="${savedId}"]`)) {
            select.value = savedId;
        }
    });

    // B. Apply views based on current dropdown states (Default or Restored)
    const processedKeys = new Set();
    document.querySelectorAll('.additive-select').forEach(select => {
        const syncKey = select.dataset.syncKey;
        // Only process each parameter group once (Desktop/Mobile share the same syncKey)
        if (!processedKeys.has(syncKey)) {
            // Force the 'other' view (e.g. if we are desktop, update mobile too) to match
            handleSelectionChange(select, true); // true = skip saving to localstorage on initial load to avoid churn
            processedKeys.add(syncKey);
        }
    });

    // C. Calculate Totals
    recalculateTotals();

    // D. Apply completed styling
    updateDoseCheckStyles();

    const params = new URLSearchParams(window.location.search);
    const targetParam = (params.get('parameter') || '').toLowerCase();
    const targetTankId = params.get('tank_id');
    if (targetParam) {
        const selector = targetTankId
            ? `[data-parameter="${CSS.escape(targetParam)}"][data-tank-id="${targetTankId}"]`
            : `[data-parameter="${CSS.escape(targetParam)}"]`;
        const targetRow = document.querySelector(selector);
        if (targetRow) {
            targetRow.classList.add('dose-plan-focus');
            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        const banner = document.getElementById('dose-plan-focus-banner');
        const bannerText = document.getElementById('dose-plan-focus-text');
        const jumpButton = document.getElementById('dose-plan-jump');
        if (banner && bannerText) {
            const label = targetParam.replace(/(^|\\s|_)([a-z])/g, (match, p1, p2) => `${p1}${p2.toUpperCase()}`);
            const tankSuffix = targetTankId ? ` (Tank ${targetTankId})` : '';
            bannerText.textContent = `Highlighting ${label}${tankSuffix}.`;
            banner.classList.remove('d-none');
            banner.classList.add('d-flex');
        }
        if (jumpButton) {
            jumpButton.addEventListener('click', () => {
                if (targetRow) {
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
    }

    const jumpTank = document.getElementById('jump-tank');
    const jumpParam = document.getElementById('jump-parameter');
    const jumpApply = document.getElementById('jump-apply');
    if (jumpApply) {
        jumpApply.addEventListener('click', () => {
            const tankId = jumpTank?.value || '';
            const param = jumpParam?.value || '';
            let selector = '';
            if (tankId && param) {
                selector = `[data-parameter="${CSS.escape(param)}"][data-tank-id="${tankId}"]`;
            } else if (param) {
                selector = `[data-parameter="${CSS.escape(param)}"]`;
            } else if (tankId) {
                selector = `[data-tank-id="${tankId}"]`;
            }
            if (!selector) return;
            const target = document.querySelector(selector);
            if (target) {
                document.querySelectorAll('.dose-plan-focus').forEach(el => el.classList.remove('dose-plan-focus'));
                target.classList.add('dose-plan-focus');
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }
});

// 2. Main Handler for Dropdown Changes
function handleSelectionChange(selectElement, skipSave = false) {
    const selectedId = selectElement.value;
    const syncKey = selectElement.dataset.syncKey;

    // A. Synchronize all dropdowns for this parameter (Desktop & Mobile)
    document.querySelectorAll(`.additive-select[data-sync-key="${syncKey}"]`).forEach(el => {
        if (el.value !== selectedId) {
            el.value = selectedId;
        }
        updateViewVisibility(el, selectedId);
    });

    // B. Save preference to Local Storage
    if (!skipSave) {
        localStorage.setItem('dose_pref_' + syncKey, selectedId);
    }

    // C. Update Totals
    recalculateTotals();
}

// 3. Toggle Visibility of Schedules/Checkboxes
function updateViewVisibility(selectElement, selectedId) {
    const row = selectElement.closest('tr');
    const card = selectElement.closest('.additive-card-group');

    // If Desktop Table Row
    if (row) {
        row.querySelectorAll('.dose-schedule-container, .dose-check-container').forEach(el => el.classList.add('d-none'));
        row.querySelectorAll(`[data-additive-id="${selectedId}"]`).forEach(el => el.classList.remove('d-none'));
    } 
    
    // If Mobile Card
    if (card) {
        card.querySelectorAll('.dose-mobile-container').forEach(el => el.classList.add('d-none'));
        card.querySelectorAll(`[data-additive-id="${selectedId}"]`).forEach(el => el.classList.remove('d-none'));
    }
}

// 4. Calculate Tank & Grand Totals
function recalculateTotals() {
    let grandTotal = 0;

    document.querySelectorAll('.tank-wrapper').forEach(tank => {
        let tankTotal = 0;

        // We use the "Desktop" dropdowns as the source of truth for math
        // (Since they are synced with mobile, the values are consistent)
        const selects = tank.querySelectorAll('.desktop-select');
        
        selects.forEach(sel => {
            const selectedOption = sel.options[sel.selectedIndex];
            // Read the ml volume from the data attribute
            const ml = parseFloat(selectedOption.dataset.ml) || 0;
            tankTotal += ml;
        });

        // Update Tank Badge
        const tankBadge = tank.querySelector('.tank-total');
        if (tankBadge) {
            tankBadge.innerText = 'Total: ' + tankTotal.toFixed(2) + ' ml';
        }

        grandTotal += tankTotal;
    });

    // Update Grand Total Badge
    const grandBadge = document.getElementById('grand-total-badge');
    if (grandBadge) {
        grandBadge.innerText = 'Total across tanks: ' + grandTotal.toFixed(2) + ' ml';
    }
}

// 5. Apply strike-through styling for completed checks
function updateDoseCheckStyles() {
    document.querySelectorAll(".dose-check").forEach((checkbox) => {
        const label = checkbox.closest("label");
        const labelText = label?.querySelector(".form-check-label") || label?.querySelector(".fw-medium");
        if (!labelText) return;
        if (checkbox.checked) {
            labelText.classList.add("text-decoration-line-through", "text-muted");
        } else {
            labelText.classList.remove("text-decoration-line-through", "text-muted");
        }
    });
}

// 5. Checkbox Logic
(function(){
  async function toggleDoseCheck(input){
    const tankId = input.dataset.tankId;
    const additiveId = input.dataset.additiveId;
    const plannedDate = input.dataset.plannedDate;
    const parameter = input.dataset.parameter;
    const amountMl = input.dataset.amountMl;
    const checked = input.checked ? 1 : 0;

    input.disabled = true;

    try{
      const res = await fetch("/tools/dose-plan/check", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          tank_id: tankId,
          additive_id: additiveId,
          parameter: parameter,
          planned_date: plannedDate,
          amount_ml: amountMl,
          checked: checked
        })
      });
      if(!res.ok){
        throw new Error(await res.text());
      }
    }catch(e){
      input.checked = !input.checked;
      alert("Failed to update dose check. " + (e && e.message ? e.message : ""));
    } finally {
      input.disabled = false;
      updateDoseCheckStyles();
    }
  }

  document.querySelectorAll(".dose-check").forEach((el)=>{
    el.addEventListener("change", ()=>toggleDoseCheck(el));
  });
})();

// ICP dose recommendations
(function(){
  async function toggleIcpDoseCheck(input){
    const sampleId = input.dataset.sampleId;
    const label = input.dataset.label;
    const checked = input.checked ? 1 : 0;
    input.disabled = true;
    try{
      const res = await fetch("/tools/icp-dose/check", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          sample_id: sampleId,
          label: label,
          checked: checked
        })
      });
      if(!res.ok){
        throw new Error(await res.text());
      }
    }catch(e){
      input.checked = !input.checked;
      alert("Failed to update ICP dose check. " + (e && e.message ? e.message : ""));
    } finally {
      input.disabled = false;
    }
  }

  document.querySelectorAll(".icp-dose-check").forEach((el)=>{
    el.addEventListener("change", ()=>toggleIcpDoseCheck(el));
  });
})();
</script>
{% endblock %}
