{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-9 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white py-3">
        <h4 class="mb-0">Daily Dosing Settings: {{ tank.name }}</h4>
      </div>
      <div class="card-body">
        <form method="post" action="/tanks/{{ tank.id }}/dosing-settings">
          <div class="row g-3 mb-3">
            <div class="col-12">
              <label class="form-label fw-bold">Dosing Methods</label>
              <div class="d-flex flex-wrap gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_all_in_one" id="use_all_in_one" data-dosing-toggle="all_in_one" {% if tank.use_all_in_one or tank.all_in_one_solution or tank.all_in_one_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_all_in_one">All-in-one</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_alk" id="use_alk" data-dosing-toggle="alk" {% if tank.use_alk or tank.alk_solution or tank.alk_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_alk">Alkalinity</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_kalkwasser" id="use_kalkwasser" data-dosing-toggle="kalkwasser" {% if tank.use_kalkwasser or tank.kalk_solution or tank.kalk_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_kalkwasser">Kalkwasser</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_ca" id="use_ca" data-dosing-toggle="ca" {% if tank.use_ca or tank.ca_solution or tank.ca_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_ca">Calcium</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_mg" id="use_mg" data-dosing-toggle="mg" {% if tank.use_mg or tank.mg_solution or tank.mg_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_mg">Magnesium</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_nitrate" id="use_nitrate" data-dosing-toggle="nitrate" {% if tank.use_nitrate or tank.nitrate_solution or tank.nitrate_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_nitrate">Nitrate</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_phosphate" id="use_phosphate" data-dosing-toggle="phosphate" {% if tank.use_phosphate or tank.phosphate_solution or tank.phosphate_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_phosphate">Phosphate</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_nopox" id="use_nopox" data-dosing-toggle="nopox" {% if tank.use_nopox or tank.nopox_daily_ml is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_nopox">NoPox</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="use_calcium_reactor" id="use_calcium_reactor" data-dosing-toggle="calcium_reactor" {% if tank.use_calcium_reactor or tank.calcium_reactor_daily_ml is not none or tank.calcium_reactor_effluent_dkh is not none %}checked{% endif %}>
                  <label class="form-check-label" for="use_calcium_reactor">Calcium Reactor</label>
                </div>
              </div>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-12 col-md-6" data-dosing-group="all_in_one">
              <label class="form-label fw-bold">All-in-one Solution</label>
              <select class="form-select" name="all_in_one_solution">
                <option value="">Select additive</option>
                {% for additive in additives %}
                  <option value="{{ additive.name }}" data-suggested="{{ suggested_dosing.get(additive.name, '') }}" {% if tank.all_in_one_solution == additive.name %}selected{% endif %}>
                    {{ additive.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="all_in_one">
              <label class="form-label fw-bold">All-in-one Daily (ml)</label>
              <input type="number" step="any" name="all_in_one_daily_ml" class="form-control" value="{{ tank.all_in_one_daily_ml if tank.all_in_one_daily_ml is not none else '' }}" placeholder="e.g. 12">
              <div class="form-text" data-suggestion-for="all_in_one_solution"></div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="alk">
              <label class="form-label fw-bold">Alkalinity Solution</label>
              <select class="form-select" name="alk_solution">
                <option value="">Select additive</option>
                {% for additive in grouped_additives.get('alkalinity', grouped_additives.get('all', additives)) %}
                  <option value="{{ additive.name }}" data-suggested="{{ suggested_dosing.get(additive.name, '') }}" {% if tank.alk_solution == additive.name %}selected{% endif %}>
                    {{ additive.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="alk">
              <label class="form-label fw-bold">Alkalinity Daily (ml)</label>
              <input type="number" step="any" name="alk_daily_ml" class="form-control" value="{{ tank.alk_daily_ml if tank.alk_daily_ml is not none else '' }}" placeholder="e.g. 25">
              <div class="form-text" data-suggestion-for="alk_solution"></div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="kalkwasser">
              <label class="form-label fw-bold">Kalkwasser Solution</label>
              <select class="form-select" name="kalk_solution">
                <option value="">Select additive</option>
                {% for additive in grouped_additives.get('alkalinity', grouped_additives.get('all', additives)) %}
                  <option value="{{ additive.name }}" data-suggested="{{ suggested_dosing.get(additive.name, '') }}" {% if tank.kalk_solution == additive.name %}selected{% endif %}>
                    {{ additive.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="kalkwasser">
              <label class="form-label fw-bold">Kalkwasser Daily (ml)</label>
              <input type="number" step="any" name="kalk_daily_ml" class="form-control" value="{{ tank.kalk_daily_ml if tank.kalk_daily_ml is not none else '' }}" placeholder="e.g. 500">
              <div class="form-text" data-suggestion-for="kalk_solution"></div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="ca">
              <label class="form-label fw-bold">Calcium Solution</label>
              <select class="form-select" name="ca_solution">
                <option value="">Select additive</option>
                {% for additive in grouped_additives.get('calcium', grouped_additives.get('all', additives)) %}
                  <option value="{{ additive.name }}" data-suggested="{{ suggested_dosing.get(additive.name, '') }}" {% if tank.ca_solution == additive.name %}selected{% endif %}>
                    {{ additive.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="ca">
              <label class="form-label fw-bold">Calcium Daily (ml)</label>
              <input type="number" step="any" name="ca_daily_ml" class="form-control" value="{{ tank.ca_daily_ml if tank.ca_daily_ml is not none else '' }}" placeholder="e.g. 20">
              <div class="form-text" data-suggestion-for="ca_solution"></div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="mg">
              <label class="form-label fw-bold">Magnesium Solution</label>
              <select class="form-select" name="mg_solution">
                <option value="">Select additive</option>
                {% for additive in grouped_additives.get('magnesium', grouped_additives.get('all', additives)) %}
                  <option value="{{ additive.name }}" data-suggested="{{ suggested_dosing.get(additive.name, '') }}" {% if tank.mg_solution == additive.name %}selected{% endif %}>
                    {{ additive.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="mg">
              <label class="form-label fw-bold">Magnesium Daily (ml)</label>
              <input type="number" step="any" name="mg_daily_ml" class="form-control" value="{{ tank.mg_daily_ml if tank.mg_daily_ml is not none else '' }}" placeholder="e.g. 15">
              <div class="form-text" data-suggestion-for="mg_solution"></div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="calcium_reactor">
              <label class="form-label fw-bold">Calcium Reactor Effluent (dKH)</label>
              <input type="number" step="any" name="calcium_reactor_effluent_dkh" class="form-control" value="{{ tank.calcium_reactor_effluent_dkh if tank.calcium_reactor_effluent_dkh is not none else '' }}" placeholder="e.g. 30">
              <div class="form-text">Enter the tested dKH of the effluent.</div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="calcium_reactor">
              <label class="form-label fw-bold">Calcium Reactor Effluent (ml/day)</label>
              <input type="number" step="any" name="calcium_reactor_daily_ml" class="form-control" value="{{ tank.calcium_reactor_daily_ml if tank.calcium_reactor_daily_ml is not none else '' }}" placeholder="e.g. 2000">
              <div class="form-text">Used to estimate daily alkalinity addition.</div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="nitrate">
              <label class="form-label fw-bold">Nitrate Solution</label>
              <select class="form-select" name="nitrate_solution">
                <option value="">Select additive</option>
                {% for additive in grouped_additives.get('nitrate', grouped_additives.get('all', additives)) %}
                  <option value="{{ additive.name }}" data-suggested="{{ suggested_dosing.get(additive.name, '') }}" {% if tank.nitrate_solution == additive.name %}selected{% endif %}>
                    {{ additive.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="nitrate">
              <label class="form-label fw-bold">Nitrate Daily (ml)</label>
              <input type="number" step="any" name="nitrate_daily_ml" class="form-control" value="{{ tank.nitrate_daily_ml if tank.nitrate_daily_ml is not none else '' }}" placeholder="e.g. 2">
              <div class="form-text" data-suggestion-for="nitrate_solution"></div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="phosphate">
              <label class="form-label fw-bold">Phosphate Solution</label>
              <select class="form-select" name="phosphate_solution">
                <option value="">Select additive</option>
                {% for additive in grouped_additives.get('phosphate', grouped_additives.get('all', additives)) %}
                  <option value="{{ additive.name }}" data-suggested="{{ suggested_dosing.get(additive.name, '') }}" {% if tank.phosphate_solution == additive.name %}selected{% endif %}>
                    {{ additive.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="phosphate">
              <label class="form-label fw-bold">Phosphate Daily (ml)</label>
              <input type="number" step="any" name="phosphate_daily_ml" class="form-control" value="{{ tank.phosphate_daily_ml if tank.phosphate_daily_ml is not none else '' }}" placeholder="e.g. 1">
              <div class="form-text" data-suggestion-for="phosphate_solution"></div>
            </div>
            <div class="col-12 col-md-6" data-dosing-group="nopox">
              <label class="form-label fw-bold">NoPox Daily (ml)</label>
              <input type="number" step="any" name="nopox_daily_ml" class="form-control" value="{{ tank.nopox_daily_ml if tank.nopox_daily_ml is not none else '' }}" placeholder="e.g. 5">
            </div>
          </div>

          <div class="border-top pt-4 mt-4">
            <h6 class="text-muted text-uppercase small mb-3">Dosing Containers</h6>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-bold">Low Container Notification Threshold (days)</label>
                <input type="number" step="any" name="dosing_low_days" class="form-control" value="{{ tank.dosing_low_days if tank.dosing_low_days is not none else 5 }}" placeholder="e.g. 5">
                <div class="form-text">Shows an in-app notification when estimated days remaining falls at or below this value.</div>
              </div>
              <div class="col-12 col-md-6" data-dosing-group="all_in_one">
                <label class="form-label fw-bold">All-in-one Container Size (ml)</label>
                <input type="number" step="any" name="all_in_one_container_ml" class="form-control" value="{{ tank.all_in_one_container_ml if tank.all_in_one_container_ml is not none else '' }}" placeholder="e.g. 2000">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="all_in_one">
                <label class="form-label fw-bold">All-in-one Remaining (ml)</label>
                <input type="number" step="any" name="all_in_one_remaining_ml" class="form-control" value="{{ tank.all_in_one_remaining_ml if tank.all_in_one_remaining_ml is not none else '' }}" placeholder="e.g. 1200">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="alk">
                <label class="form-label fw-bold">Alkalinity Container Size (ml)</label>
                <input type="number" step="any" name="alk_container_ml" class="form-control" value="{{ tank.alk_container_ml if tank.alk_container_ml is not none else '' }}" placeholder="e.g. 2000">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="alk">
                <label class="form-label fw-bold">Alkalinity Remaining (ml)</label>
                <input type="number" step="any" name="alk_remaining_ml" class="form-control" value="{{ tank.alk_remaining_ml if tank.alk_remaining_ml is not none else '' }}" placeholder="e.g. 1200">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="kalkwasser">
                <label class="form-label fw-bold">Kalkwasser Container Size (ml)</label>
                <input type="number" step="any" name="kalk_container_ml" class="form-control" value="{{ tank.kalk_container_ml if tank.kalk_container_ml is not none else '' }}" placeholder="e.g. 5000">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="kalkwasser">
                <label class="form-label fw-bold">Kalkwasser Remaining (ml)</label>
                <input type="number" step="any" name="kalk_remaining_ml" class="form-control" value="{{ tank.kalk_remaining_ml if tank.kalk_remaining_ml is not none else '' }}" placeholder="e.g. 3500">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="ca">
                <label class="form-label fw-bold">Calcium Container Size (ml)</label>
                <input type="number" step="any" name="ca_container_ml" class="form-control" value="{{ tank.ca_container_ml if tank.ca_container_ml is not none else '' }}" placeholder="e.g. 2000">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="ca">
                <label class="form-label fw-bold">Calcium Remaining (ml)</label>
                <input type="number" step="any" name="ca_remaining_ml" class="form-control" value="{{ tank.ca_remaining_ml if tank.ca_remaining_ml is not none else '' }}" placeholder="e.g. 1200">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="mg">
                <label class="form-label fw-bold">Magnesium Container Size (ml)</label>
                <input type="number" step="any" name="mg_container_ml" class="form-control" value="{{ tank.mg_container_ml if tank.mg_container_ml is not none else '' }}" placeholder="e.g. 2000">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="mg">
                <label class="form-label fw-bold">Magnesium Remaining (ml)</label>
                <input type="number" step="any" name="mg_remaining_ml" class="form-control" value="{{ tank.mg_remaining_ml if tank.mg_remaining_ml is not none else '' }}" placeholder="e.g. 1200">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="nitrate">
                <label class="form-label fw-bold">Nitrate Container Size (ml)</label>
                <input type="number" step="any" name="nitrate_container_ml" class="form-control" value="{{ tank.nitrate_container_ml if tank.nitrate_container_ml is not none else '' }}" placeholder="e.g. 500">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="nitrate">
                <label class="form-label fw-bold">Nitrate Remaining (ml)</label>
                <input type="number" step="any" name="nitrate_remaining_ml" class="form-control" value="{{ tank.nitrate_remaining_ml if tank.nitrate_remaining_ml is not none else '' }}" placeholder="e.g. 300">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="phosphate">
                <label class="form-label fw-bold">Phosphate Container Size (ml)</label>
                <input type="number" step="any" name="phosphate_container_ml" class="form-control" value="{{ tank.phosphate_container_ml if tank.phosphate_container_ml is not none else '' }}" placeholder="e.g. 500">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="phosphate">
                <label class="form-label fw-bold">Phosphate Remaining (ml)</label>
                <input type="number" step="any" name="phosphate_remaining_ml" class="form-control" value="{{ tank.phosphate_remaining_ml if tank.phosphate_remaining_ml is not none else '' }}" placeholder="e.g. 300">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="nopox">
                <label class="form-label fw-bold">NoPox Container Size (ml)</label>
                <input type="number" step="any" name="nopox_container_ml" class="form-control" value="{{ tank.nopox_container_ml if tank.nopox_container_ml is not none else '' }}" placeholder="e.g. 1000">
              </div>
              <div class="col-12 col-md-6" data-dosing-group="nopox">
                <label class="form-label fw-bold">NoPox Remaining (ml)</label>
                <input type="number" step="any" name="nopox_remaining_ml" class="form-control" value="{{ tank.nopox_remaining_ml if tank.nopox_remaining_ml is not none else '' }}" placeholder="e.g. 600">
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-4">
            <a href="/tanks/{{ tank.id }}" class="text-decoration-none">Cancel</a>
            <button type="submit" class="btn btn-primary px-4">Save Dosing</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const dosingToggles = document.querySelectorAll('[data-dosing-toggle]');
  const dosingFields = document.querySelectorAll('[data-dosing-group]');

  function updateDosingFields() {
    const toggleMap = {};
    dosingToggles.forEach((toggle) => {
      toggleMap[toggle.dataset.dosingToggle] = toggle.checked;
    });
    dosingFields.forEach((field) => {
      const group = field.dataset.dosingGroup;
      const shouldShow = toggleMap[group];
      field.classList.toggle('d-none', !shouldShow);
    });
  }

  dosingToggles.forEach((toggle) => toggle.addEventListener('change', updateDosingFields));
  updateDosingFields();

  function updateSuggestions() {
    document.querySelectorAll('select[name$="_solution"]').forEach((select) => {
      const suggestionTarget = document.querySelector(`[data-suggestion-for="${select.name}"]`);
      if (!suggestionTarget) return;
      const selected = select.selectedOptions[0];
      const suggested = selected ? selected.dataset.suggested : '';
      suggestionTarget.textContent = suggested ? `Suggested start: ${suggested} ml/day` : '';
    });
  }

  document.querySelectorAll('select[name$="_solution"]').forEach((select) => {
    select.addEventListener('change', updateSuggestions);
  });
  updateSuggestions();
</script>
{% endblock %}
