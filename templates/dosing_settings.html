{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-9 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white py-3">
        <h4 class="mb-0">Daily Dosing Settings: {{ tank.name }}</h4>
      </div>
      <div class="card-body">
        <form method="post" action="/tanks/{{ tank.id }}/dosing-settings">
          <div class="border rounded-3 bg-light-subtle p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
              <div class="fw-semibold">Dosing Entries</div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addDosingRow">Add Dosing Entry</button>
            </div>
            <div class="small text-muted mb-3">Add as many dosing entries as you need, even multiple of the same type.</div>
            <div id="dosing-rows" class="d-grid gap-3" data-tank-volume="{{ tank.volume_l or '' }}">
              {% for entry in dosing_entries %}
                <div class="row g-2 align-items-end dosing-row">
                  <div class="col-12 col-md-4">
                    <label class="form-label fw-bold">Additive</label>
                    <select class="form-select dosing-solution" name="dosing_solution[]">
                      <option value="">Select additive</option>
                      <option value="NoPox" data-parameter="NoPox" {% if entry.solution == "NoPox" %}selected{% endif %}>NoPox</option>
                      {% for additive in additives %}
                        <option value="{{ additive.name }}" data-parameter="{{ additive.parameter }}" {% if entry.solution == additive.name %}selected{% endif %}>
                          {{ additive|additive_label }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label fw-bold">Daily (ml)</label>
                    <input type="number" step="any" name="dosing_daily_ml[]" class="form-control" value="{{ entry.daily_ml if entry.daily_ml is not none else '' }}" placeholder="e.g. 5">
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label fw-bold">Container (ml)</label>
                    <input type="number" step="any" name="dosing_container_ml[]" class="form-control" value="{{ entry.container_ml if entry.container_ml is not none else '' }}" placeholder="ml">
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label fw-bold">Remaining (ml)</label>
                    <input type="number" step="any" name="dosing_remaining_ml[]" class="form-control" value="{{ entry.remaining_ml if entry.remaining_ml is not none else '' }}" placeholder="ml">
                    <div class="d-grid gap-1 mt-2">
                      <button type="button" class="btn btn-outline-secondary btn-sm autofill-remaining">Refill</button>
                      <button type="button" class="btn btn-outline-danger btn-sm remove-dosing-row">Remove</button>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-danger small d-none dosing-row-warning">Select an additive and enter a daily amount to save this row.</div>
                  </div>
                </div>
              {% endfor %}
              <div class="row g-2 align-items-end dosing-row">
                <div class="col-12 col-md-4">
                  <label class="form-label fw-bold">Additive</label>
                  <select class="form-select dosing-solution" name="dosing_solution[]">
                    <option value="">Select additive</option>
                    <option value="NoPox" data-parameter="NoPox">NoPox</option>
                    {% for additive in additives %}
                      <option value="{{ additive.name }}" data-parameter="{{ additive.parameter }}">{{ additive|additive_label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-12 col-md-2">
                  <label class="form-label fw-bold">Daily (ml)</label>
                  <input type="number" step="any" name="dosing_daily_ml[]" class="form-control" placeholder="e.g. 5">
                </div>
                <div class="col-12 col-md-2">
                  <label class="form-label fw-bold">Container (ml)</label>
                  <input type="number" step="any" name="dosing_container_ml[]" class="form-control" placeholder="ml">
                </div>
                <div class="col-12 col-md-2">
                  <label class="form-label fw-bold">Remaining (ml)</label>
                  <input type="number" step="any" name="dosing_remaining_ml[]" class="form-control" placeholder="ml">
                  <div class="d-grid gap-1 mt-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm autofill-remaining">Refill</button>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-dosing-row">Remove</button>
                  </div>
                </div>
                <div class="col-12">
                  <div class="text-danger small d-none dosing-row-warning">Select an additive and enter a daily amount to save this row.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="border rounded-3 p-3 mb-4">
            <div class="fw-semibold mb-3">Calcium Reactor</div>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold">Calcium Reactor Effluent (dKH)</label>
                <input type="number" step="any" name="calcium_reactor_effluent_dkh" class="form-control" value="{{ tank.calcium_reactor_effluent_dkh if tank.calcium_reactor_effluent_dkh is not none else '' }}" placeholder="e.g. 30">
                <div class="form-text">Enter the tested dKH of the effluent.</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold">Calcium Reactor Effluent (ml/day)</label>
                <input type="number" step="any" name="calcium_reactor_daily_ml" class="form-control" value="{{ tank.calcium_reactor_daily_ml if tank.calcium_reactor_daily_ml is not none else '' }}" placeholder="e.g. 2000">
                <div class="form-text">Used to estimate daily alkalinity addition.</div>
              </div>
            </div>
          </div>

          <div class="border-top pt-4 mt-4">
            <h6 class="text-muted text-uppercase small mb-3">Notifications</h6>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-bold">Low Container Notification Threshold (days)</label>
                <input type="number" step="any" name="dosing_low_days" class="form-control" value="{{ tank.dosing_low_days if tank.dosing_low_days is not none else 5 }}" placeholder="e.g. 5">
                <div class="form-text">Shows an in-app notification when estimated days remaining falls at or below this value.</div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-4">
            <a href="/tanks/{{ tank.id }}" class="text-decoration-none">Cancel</a>
            <button type="submit" class="btn btn-primary px-4" id="save-dosing-button">Save Dosing</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const dosingRowsContainer = document.getElementById('dosing-rows');
  const addDosingRowButton = document.getElementById('addDosingRow');

  function wireDosingRow(row) {
    const removeButton = row.querySelector('.remove-dosing-row');
    const autofillButton = row.querySelector('.autofill-remaining');
    if (removeButton) {
      removeButton.addEventListener('click', () => {
        row.remove();
        validateDosingRows();
      });
    }
    if (autofillButton) {
      autofillButton.addEventListener('click', () => {
        const containerInput = row.querySelector('input[name="dosing_container_ml[]"]');
        const remainingInput = row.querySelector('input[name="dosing_remaining_ml[]"]');
        if (containerInput && remainingInput) {
          remainingInput.value = containerInput.value;
          validateDosingRows();
        }
      });
    }
  }

  if (dosingRowsContainer) {
    dosingRowsContainer.querySelectorAll('.dosing-row').forEach(wireDosingRow);
  }

  if (addDosingRowButton && dosingRowsContainer) {
    addDosingRowButton.addEventListener('click', () => {
      const template = dosingRowsContainer.querySelector('.dosing-row');
      if (!template) return;
      const clone = template.cloneNode(true);
      clone.querySelectorAll('input').forEach((input) => {
        input.value = '';
      });
      clone.querySelectorAll('select').forEach((select) => {
        select.selectedIndex = 0;
      });
      dosingRowsContainer.appendChild(clone);
      wireDosingRow(clone);
      validateDosingRows();
    });
  }

  const saveButton = document.getElementById('save-dosing-button');

  function validateDosingRows() {
    let hasInvalid = false;
    document.querySelectorAll('.dosing-row').forEach((row) => {
      const solution = row.querySelector('.dosing-solution')?.value?.trim() || '';
      const daily = row.querySelector('input[name="dosing_daily_ml[]"]')?.value?.trim() || '';
      const warning = row.querySelector('.dosing-row-warning');
      const isEmpty = !solution && !daily;
      const isValid = (solution && daily) || isEmpty;
      if (warning) {
        warning.classList.toggle('d-none', isValid);
      }
      if (!isValid) {
        hasInvalid = true;
      }
    });
    if (saveButton) {
      saveButton.disabled = hasInvalid;
    }
  }

  document.querySelectorAll('.dosing-solution, input[name="dosing_daily_ml[]"]').forEach((input) => {
    input.addEventListener('input', validateDosingRows);
    input.addEventListener('change', validateDosingRows);
  });
  validateDosingRows();
</script>
{% endblock %}
