{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <div>
    <h2 class="mb-1">Parameters</h2>
    <div class="text-muted small">Organize core readings and trace elements in one place.</div>
  </div>
  <div class="d-flex gap-2">
    <a href="/admin/merge-parameters" class="btn btn-outline-secondary">
      <i class="bi bi-intersect"></i> Merge Params
    </a>
    <a href="/settings/parameters/new" class="btn btn-primary">
      <i class="bi bi-plus-lg"></i> New
    </a>
  </div>
</div>

{% if error %}
  <div class="alert alert-danger" role="alert">
    {{ error }}
  </div>
{% endif %}

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
          <div>
            <h5 class="mb-0">All parameters</h5>
            <div class="text-muted small">Search, edit, and review testing intervals.</div>
          </div>
          <div class="input-group input-group-sm parameter-search">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input class="form-control" type="text" placeholder="Search parameters" data-parameter-search>
          </div>
        </div>
        <div class="accordion" id="parameterAccordion">
          {% for group in grouped_parameters %}
            {% set collapse_id = "parameter-group-" ~ loop.index %}
            <div class="accordion-item" data-parameter-group>
              <h2 class="accordion-header" id="{{ collapse_id }}-heading">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="{{ collapse_id }}">
                  <span class="fw-semibold text-navy">{{ group.name }}</span>
                  <span class="badge bg-light text-secondary border ms-2">{{ group["items"]|length }}</span>
                </button>
              </h2>
              <div id="{{ collapse_id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="{{ collapse_id }}-heading" data-bs-parent="#parameterAccordion">
                <div class="accordion-body">
                  <div class="row g-2">
                    {% for p in group["items"] %}
                      <div class="col-md-6">
                        <div class="parameter-card border rounded-3 p-3 h-100" data-parameter-card>
                          <div class="d-flex justify-content-between align-items-start gap-2">
                            <div>
                              <div class="fw-semibold">{{ p.name }}</div>
                              <div class="text-muted small">
                                {{ p.unit or "Unit not set" }}
                                {% if p.chemical_symbol %}
                                  <span class="ms-2 text-uppercase">({{ p.chemical_symbol }})</span>
                                {% endif %}
                              </div>
                            </div>
                            <a href="/settings/parameters/{{ p.id }}/edit" class="btn btn-sm btn-outline-secondary">Edit</a>
                          </div>
                          {% if p.test_interval_days %}
                            <div class="mt-2">
                              <span class="badge bg-light text-secondary border">{{ p.test_interval_days }} day interval</span>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="mb-1">Add trace elements</h5>
        <div class="text-muted small mb-3">Paste one per line, optionally “Name, unit”.</div>
        <form method="post" action="/settings/parameters/bulk-add">
          <div class="mb-3">
            <label class="form-label small">Default unit</label>
            <input class="form-control form-control-sm" name="bulk_unit" placeholder="ppm">
          </div>
          <div class="mb-3">
            <label class="form-label small">Parameters</label>
            <textarea class="form-control" rows="8" name="bulk_parameters" placeholder="Iron, ppm&#10;Iodine, ppm&#10;Strontium, ppm"></textarea>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary btn-sm" type="submit">Add Parameters</button>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-fill-trace>
              Fill common trace list
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.querySelector("[data-parameter-search]");
    const cards = Array.from(document.querySelectorAll("[data-parameter-card]"));
    const groups = Array.from(document.querySelectorAll("[data-parameter-group]"));
    if (searchInput) {
      searchInput.addEventListener("input", (event) => {
        const value = event.target.value.toLowerCase();
        cards.forEach((card) => {
          const text = card.textContent.toLowerCase();
          card.parentElement.classList.toggle("d-none", !text.includes(value));
        });
        groups.forEach((group) => {
          const visibleCards = group.querySelectorAll(".col-md-6:not(.d-none)");
          group.classList.toggle("d-none", visibleCards.length === 0);
        });
      });
    }
    const fillButton = document.querySelector("[data-fill-trace]");
    if (fillButton) {
      fillButton.addEventListener("click", () => {
        const textarea = document.querySelector("textarea[name='bulk_parameters']");
        if (!textarea) return;
        textarea.value = [
          "Iron, ppm",
          "Iodine, ppm",
          "Strontium, ppm",
          "Potassium, ppm",
          "Boron, ppm",
          "Fluoride, ppm",
          "Manganese, ppm",
          "Molybdenum, ppm",
          "Zinc, ppm",
          "Cobalt, ppm",
        ].join("\\n");
      });
    }
  });
</script>
{% endblock %}
