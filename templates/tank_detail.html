{% extends "base.html" %}
{% block content %}
<style>
  @media (max-width: 575.98px) {
    .tank-action-bar {
      width: 100%;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tank-action-bar .btn {
      padding: 0.35rem 0.5rem;
      font-size: 0.85rem;
      line-height: 1.1;
    }
    .tank-action-bar .btn i {
      margin-right: 0.25rem;
    }
    .tank-action-bar .dropdown-toggle::after {
      margin-left: 0.25rem;
    }
    .dose-solution-name {
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
  .dose-container {
    position: relative;
    width: 54px;
    height: 74px;
    border: 2px solid #4a67a1;
    border-radius: 10px 10px 8px 8px;
    background: rgba(74, 103, 161, 0.08);
    overflow: hidden;
    margin-top: -2px;
  }
  .dose-liquid {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    opacity: 0.35;
  }
  .dose-markings {
    position: absolute;
    top: 12px;
    bottom: 8px;
    right: 6px;
    width: 12px;
    background: repeating-linear-gradient(
      to bottom,
      rgba(74, 103, 161, 0.7) 0 2px,
      transparent 2px 9px
    );
    pointer-events: none;
  }
</style>
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
  <div>
    <h1 class="h2 mb-0 fw-bold text-navy d-flex flex-wrap align-items-center gap-2">
      <span>{{ tank.name }}</span>
      {% if tank.volume_l %}
        <span class="badge bg-light text-secondary border fs-6 d-inline-flex d-sm-none">{{ tank.volume_l }} Liters</span>
      {% endif %}
    </h1>
    <div class="text-muted small d-flex gap-3 align-items-center mt-1">
      {% if tank.volume_l %}
        <span class="badge bg-light text-secondary border fs-6 d-none d-sm-inline-flex">{{ tank.volume_l }} Liters</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex flex-wrap gap-2 justify-content-end align-items-center tank-action-bar">
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}/snapshot">
      <i class="bi bi-file-earmark-text"></i> Snapshot
    </a>
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}/journal">
      <i class="bi bi-journal-text"></i> Journal
    </a>
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}/dosing-log">
      <i class="bi bi-droplet-half"></i> Dosing Log
    </a>
    <a class="btn btn-primary" href="/tanks/{{ tank.id }}/add">
      <i class="bi bi-clipboard-plus"></i> Log Test
    </a>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Settings
      </button>
      <ul class="dropdown-menu dropdown-menu-end shadow-sm">
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/targets"><i class="bi bi-bullseye"></i> Targets</a></li>
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/profile"><i class="bi bi-pencil-square"></i> Edit Tank</a></li>
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/export"><i class="bi bi-file-earmark-spreadsheet"></i> Export Excel</a></li>
        <li><hr class="dropdown-divider"></li>
        <li>
             <form method="post" action="/tanks/{{ tank.id }}/delete" onsubmit="return confirm('Really delete?');" class="d-inline">
                <button class="dropdown-item text-danger" type="submit">Delete Tank</button>
             </form>
        </li>
      </ul>
    </div>
  </div>
</div>

{% if low_container_alerts %}
  <div class="alert alert-warning small mb-4">
    <div class="fw-semibold">Dosing containers running low (≤ {{ tank.dosing_low_days }} days)</div>
    <ul class="mb-0">
      {% for alert in low_container_alerts %}
        <li>{{ alert.label }}: {{ alert.days|round(1) }} days remaining</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% set has_dosing = tank.use_all_in_one or tank.use_alk or tank.use_kalkwasser or tank.use_ca or tank.use_mg or tank.use_nitrate or tank.use_phosphate or tank.use_trace or tank.use_nopox or tank.use_calcium_reactor or tank.all_in_one_solution or tank.alk_solution or tank.kalk_solution or tank.ca_solution or tank.mg_solution or tank.nitrate_solution or tank.phosphate_solution or tank.trace_solution or tank.nopox_daily_ml or tank.all_in_one_daily_ml or tank.alk_daily_ml or tank.kalk_daily_ml or tank.ca_daily_ml or tank.mg_daily_ml or tank.nitrate_daily_ml or tank.phosphate_daily_ml or tank.trace_daily_ml or tank.calcium_reactor_daily_ml or tank.calcium_reactor_effluent_dkh or (extra_dosing_entries and extra_dosing_entries|length > 0) %}
{% if has_dosing %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0 h5 fw-bold">Daily Dosing</h4>
    <a class="btn btn-outline-secondary btn-sm" href="/tanks/{{ tank.id }}/dosing-settings">
      <i class="bi bi-gear"></i> Edit Dosing
    </a>
  </div>
  {% set ns = namespace(methods=[]) %}
  {% if tank.use_all_in_one or tank.all_in_one_solution or tank.all_in_one_daily_ml is not none %}{% set _ = ns.methods.append("All-in-one") %}{% endif %}
  {% if tank.use_alk or tank.alk_solution or tank.alk_daily_ml is not none %}{% set _ = ns.methods.append("Alkalinity") %}{% endif %}
  {% if tank.use_kalkwasser or tank.kalk_solution or tank.kalk_daily_ml is not none %}{% set _ = ns.methods.append("Kalkwasser") %}{% endif %}
  {% if tank.use_ca or tank.ca_solution or tank.ca_daily_ml is not none %}{% set _ = ns.methods.append("Calcium") %}{% endif %}
  {% if tank.use_mg or tank.mg_solution or tank.mg_daily_ml is not none %}{% set _ = ns.methods.append("Magnesium") %}{% endif %}
  {% if tank.use_nitrate or tank.nitrate_solution or tank.nitrate_daily_ml is not none %}{% set _ = ns.methods.append("Nitrate") %}{% endif %}
  {% if tank.use_phosphate or tank.phosphate_solution or tank.phosphate_daily_ml is not none %}{% set _ = ns.methods.append("Phosphate") %}{% endif %}
  {% if tank.use_trace or tank.trace_solution or tank.trace_daily_ml is not none %}{% set _ = ns.methods.append("Trace Elements") %}{% endif %}
  {% if tank.use_nopox or tank.nopox_daily_ml is not none %}{% set _ = ns.methods.append("NoPox") %}{% endif %}
  {% if tank.use_calcium_reactor or tank.calcium_reactor_daily_ml is not none or tank.calcium_reactor_effluent_dkh is not none %}{% set _ = ns.methods.append("Calcium Reactor") %}{% endif %}
  <div class="mb-3 text-muted small">
    Methods: {{ ns.methods|join(", ") if ns.methods else "Not specified" }}
  </div>
  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-5">
        {% if tank.use_all_in_one or tank.all_in_one_solution or tank.all_in_one_daily_ml %}
          {% set all_in_one_remaining = tank.all_in_one_remaining_ml if tank.all_in_one_remaining_ml is not none else tank.all_in_one_container_ml %}
          {% set all_in_one_pct = (all_in_one_remaining / tank.all_in_one_container_ml * 100) if tank.all_in_one_container_ml else none %}
          {% if all_in_one_pct is not none and all_in_one_pct > 100 %}{% set all_in_one_pct = 100 %}{% endif %}
          {% if all_in_one_pct is not none and all_in_one_pct < 0 %}{% set all_in_one_pct = 0 %}{% endif %}
          {% set all_in_one_days = (all_in_one_remaining / tank.all_in_one_daily_ml) if (all_in_one_remaining is not none and tank.all_in_one_daily_ml) else none %}
          {% set all_in_one_color = "var(--bs-primary)" %}
          {% if all_in_one_pct is not none and all_in_one_pct <= 20 %}{% set all_in_one_color = "var(--bs-danger)" %}{% elif all_in_one_pct is not none and all_in_one_pct <= 50 %}{% set all_in_one_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">All-in-one</div>
                <div class="fw-semibold dose-solution-name">{{ tank.all_in_one_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.all_in_one_daily_ml|fmt2 if tank.all_in_one_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.all_in_one_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ all_in_one_pct }}%; background: {{ all_in_one_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ all_in_one_remaining|fmt2 }} / {{ tank.all_in_one_container_ml|fmt2 }} ml</div>
                      {% if all_in_one_days is not none %}
                        <div class="text-muted small text-nowrap">{{ all_in_one_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="all_in_one">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if tank.use_alk or tank.alk_solution or tank.alk_daily_ml is not none %}
          {% set alk_remaining = tank.alk_remaining_ml if tank.alk_remaining_ml is not none else tank.alk_container_ml %}
          {% set alk_pct = (alk_remaining / tank.alk_container_ml * 100) if tank.alk_container_ml else none %}
          {% if alk_pct is not none and alk_pct > 100 %}{% set alk_pct = 100 %}{% endif %}
          {% if alk_pct is not none and alk_pct < 0 %}{% set alk_pct = 0 %}{% endif %}
          {% set alk_days = (alk_remaining / tank.alk_daily_ml) if (alk_remaining is not none and tank.alk_daily_ml) else none %}
          {% set alk_color = "var(--bs-primary)" %}
          {% if alk_pct is not none and alk_pct <= 20 %}{% set alk_color = "var(--bs-danger)" %}{% elif alk_pct is not none and alk_pct <= 50 %}{% set alk_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Alkalinity</div>
                <div class="fw-semibold dose-solution-name">{{ tank.alk_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.alk_daily_ml|fmt2 if tank.alk_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.alk_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ alk_pct }}%; background: {{ alk_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ alk_remaining|fmt2 }} / {{ tank.alk_container_ml|fmt2 }} ml</div>
                      {% if alk_days is not none %}
                        <div class="text-muted small text-nowrap">{{ alk_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="alk">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if tank.use_kalkwasser or tank.kalk_solution or tank.kalk_daily_ml is not none %}
          {% set kalk_remaining = tank.kalk_remaining_ml if tank.kalk_remaining_ml is not none else tank.kalk_container_ml %}
          {% set kalk_pct = (kalk_remaining / tank.kalk_container_ml * 100) if tank.kalk_container_ml else none %}
          {% if kalk_pct is not none and kalk_pct > 100 %}{% set kalk_pct = 100 %}{% endif %}
          {% if kalk_pct is not none and kalk_pct < 0 %}{% set kalk_pct = 0 %}{% endif %}
          {% set kalk_days = (kalk_remaining / tank.kalk_daily_ml) if (kalk_remaining is not none and tank.kalk_daily_ml) else none %}
          {% set kalk_color = "var(--bs-primary)" %}
          {% if kalk_pct is not none and kalk_pct <= 20 %}{% set kalk_color = "var(--bs-danger)" %}{% elif kalk_pct is not none and kalk_pct <= 50 %}{% set kalk_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Kalkwasser</div>
                <div class="fw-semibold dose-solution-name">{{ tank.kalk_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.kalk_daily_ml|fmt2 if tank.kalk_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.kalk_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ kalk_pct }}%; background: {{ kalk_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ kalk_remaining|fmt2 }} / {{ tank.kalk_container_ml|fmt2 }} ml</div>
                      {% if kalk_days is not none %}
                        <div class="text-muted small text-nowrap">{{ kalk_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="kalk">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if tank.use_ca or tank.ca_solution or tank.ca_daily_ml is not none %}
          {% set ca_remaining = tank.ca_remaining_ml if tank.ca_remaining_ml is not none else tank.ca_container_ml %}
          {% set ca_pct = (ca_remaining / tank.ca_container_ml * 100) if tank.ca_container_ml else none %}
          {% if ca_pct is not none and ca_pct > 100 %}{% set ca_pct = 100 %}{% endif %}
          {% if ca_pct is not none and ca_pct < 0 %}{% set ca_pct = 0 %}{% endif %}
          {% set ca_days = (ca_remaining / tank.ca_daily_ml) if (ca_remaining is not none and tank.ca_daily_ml) else none %}
          {% set ca_color = "var(--bs-primary)" %}
          {% if ca_pct is not none and ca_pct <= 20 %}{% set ca_color = "var(--bs-danger)" %}{% elif ca_pct is not none and ca_pct <= 50 %}{% set ca_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Calcium</div>
                <div class="fw-semibold dose-solution-name">{{ tank.ca_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.ca_daily_ml|fmt2 if tank.ca_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.ca_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ ca_pct }}%; background: {{ ca_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ ca_remaining|fmt2 }} / {{ tank.ca_container_ml|fmt2 }} ml</div>
                      {% if ca_days is not none %}
                        <div class="text-muted small text-nowrap">{{ ca_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="ca">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if tank.use_mg or tank.mg_solution or tank.mg_daily_ml is not none %}
          {% set mg_remaining = tank.mg_remaining_ml if tank.mg_remaining_ml is not none else tank.mg_container_ml %}
          {% set mg_pct = (mg_remaining / tank.mg_container_ml * 100) if tank.mg_container_ml else none %}
          {% if mg_pct is not none and mg_pct > 100 %}{% set mg_pct = 100 %}{% endif %}
          {% if mg_pct is not none and mg_pct < 0 %}{% set mg_pct = 0 %}{% endif %}
          {% set mg_days = (mg_remaining / tank.mg_daily_ml) if (mg_remaining is not none and tank.mg_daily_ml) else none %}
          {% set mg_color = "var(--bs-primary)" %}
          {% if mg_pct is not none and mg_pct <= 20 %}{% set mg_color = "var(--bs-danger)" %}{% elif mg_pct is not none and mg_pct <= 50 %}{% set mg_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Magnesium</div>
                <div class="fw-semibold dose-solution-name">{{ tank.mg_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.mg_daily_ml|fmt2 if tank.mg_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.mg_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ mg_pct }}%; background: {{ mg_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ mg_remaining|fmt2 }} / {{ tank.mg_container_ml|fmt2 }} ml</div>
                      {% if mg_days is not none %}
                        <div class="text-muted small text-nowrap">{{ mg_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="mg">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if tank.use_nitrate or tank.nitrate_solution or tank.nitrate_daily_ml is not none %}
          {% set nitrate_remaining = tank.nitrate_remaining_ml if tank.nitrate_remaining_ml is not none else tank.nitrate_container_ml %}
          {% set nitrate_pct = (nitrate_remaining / tank.nitrate_container_ml * 100) if tank.nitrate_container_ml else none %}
          {% if nitrate_pct is not none and nitrate_pct > 100 %}{% set nitrate_pct = 100 %}{% endif %}
          {% if nitrate_pct is not none and nitrate_pct < 0 %}{% set nitrate_pct = 0 %}{% endif %}
          {% set nitrate_days = (nitrate_remaining / tank.nitrate_daily_ml) if (nitrate_remaining is not none and tank.nitrate_daily_ml) else none %}
          {% set nitrate_color = "var(--bs-primary)" %}
          {% if nitrate_pct is not none and nitrate_pct <= 20 %}{% set nitrate_color = "var(--bs-danger)" %}{% elif nitrate_pct is not none and nitrate_pct <= 50 %}{% set nitrate_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Nitrate</div>
                <div class="fw-semibold dose-solution-name">{{ tank.nitrate_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.nitrate_daily_ml|fmt2 if tank.nitrate_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.nitrate_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ nitrate_pct }}%; background: {{ nitrate_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ nitrate_remaining|fmt2 }} / {{ tank.nitrate_container_ml|fmt2 }} ml</div>
                      {% if nitrate_days is not none %}
                        <div class="text-muted small text-nowrap">{{ nitrate_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="nitrate">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if tank.use_phosphate or tank.phosphate_solution or tank.phosphate_daily_ml is not none %}
          {% set phosphate_remaining = tank.phosphate_remaining_ml if tank.phosphate_remaining_ml is not none else tank.phosphate_container_ml %}
          {% set phosphate_pct = (phosphate_remaining / tank.phosphate_container_ml * 100) if tank.phosphate_container_ml else none %}
          {% if phosphate_pct is not none and phosphate_pct > 100 %}{% set phosphate_pct = 100 %}{% endif %}
          {% if phosphate_pct is not none and phosphate_pct < 0 %}{% set phosphate_pct = 0 %}{% endif %}
          {% set phosphate_days = (phosphate_remaining / tank.phosphate_daily_ml) if (phosphate_remaining is not none and tank.phosphate_daily_ml) else none %}
          {% set phosphate_color = "var(--bs-primary)" %}
          {% if phosphate_pct is not none and phosphate_pct <= 20 %}{% set phosphate_color = "var(--bs-danger)" %}{% elif phosphate_pct is not none and phosphate_pct <= 50 %}{% set phosphate_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Phosphate</div>
                <div class="fw-semibold dose-solution-name">{{ tank.phosphate_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.phosphate_daily_ml|fmt2 if tank.phosphate_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.phosphate_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ phosphate_pct }}%; background: {{ phosphate_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ phosphate_remaining|fmt2 }} / {{ tank.phosphate_container_ml|fmt2 }} ml</div>
                      {% if phosphate_days is not none %}
                        <div class="text-muted small text-nowrap">{{ phosphate_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="phosphate">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if tank.use_trace or tank.trace_solution or tank.trace_daily_ml is not none %}
          {% set trace_remaining = tank.trace_remaining_ml if tank.trace_remaining_ml is not none else tank.trace_container_ml %}
          {% set trace_pct = (trace_remaining / tank.trace_container_ml * 100) if tank.trace_container_ml else none %}
          {% if trace_pct is not none and trace_pct > 100 %}{% set trace_pct = 100 %}{% endif %}
          {% if trace_pct is not none and trace_pct < 0 %}{% set trace_pct = 0 %}{% endif %}
          {% set trace_days = (trace_remaining / tank.trace_daily_ml) if (trace_remaining is not none and tank.trace_daily_ml) else none %}
          {% set trace_color = "var(--bs-primary)" %}
          {% if trace_pct is not none and trace_pct <= 20 %}{% set trace_color = "var(--bs-danger)" %}{% elif trace_pct is not none and trace_pct <= 50 %}{% set trace_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Trace Elements</div>
                <div class="fw-semibold dose-solution-name">{{ tank.trace_solution or "—" }}</div>
                <div class="text-secondary small">{{ tank.trace_daily_ml|fmt2 if tank.trace_daily_ml is not none else "—" }} ml/day</div>
                {% if tank.trace_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ trace_pct }}%; background: {{ trace_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ trace_remaining|fmt2 }} / {{ tank.trace_container_ml|fmt2 }} ml</div>
                      {% if trace_days is not none %}
                        <div class="text-muted small text-nowrap">{{ trace_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="trace">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        {% if extra_dosing_entries %}
          {% for entry in extra_dosing_entries %}
            {% set extra_remaining = entry.remaining_ml if entry.remaining_ml is not none else entry.container_ml %}
            {% set extra_pct = (extra_remaining / entry.container_ml * 100) if entry.container_ml else none %}
            {% if extra_pct is not none and extra_pct > 100 %}{% set extra_pct = 100 %}{% endif %}
            {% if extra_pct is not none and extra_pct < 0 %}{% set extra_pct = 0 %}{% endif %}
            {% set extra_days = (extra_remaining / entry.daily_ml) if (extra_remaining is not none and entry.daily_ml) else none %}
            {% set extra_color = "var(--bs-primary)" %}
            {% if extra_pct is not none and extra_pct <= 20 %}{% set extra_color = "var(--bs-danger)" %}{% elif extra_pct is not none and extra_pct <= 50 %}{% set extra_color = "var(--bs-warning)" %}{% endif %}
            <div class="col">
              <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-3">
                  <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">{{ entry.parameter or "Dosing" }}</div>
                  <div class="fw-semibold dose-solution-name">{{ entry.solution or "—" }}</div>
                  <div class="text-secondary small">{{ entry.daily_ml|fmt2 if entry.daily_ml is not none else "—" }} ml/day</div>
                  {% if entry.container_ml %}
                    <div class="d-flex align-items-start gap-2 mt-2">
                      <div class="dose-container">
                        <div class="dose-liquid" style="height: {{ extra_pct }}%; background: {{ extra_color }};"></div>
                        <div class="dose-markings"></div>
                      </div>
                      <div>
                        <div class="text-muted small">{{ extra_remaining|fmt2 }} / {{ entry.container_ml|fmt2 }} ml</div>
                        {% if extra_days is not none %}
                          <div class="text-muted small text-nowrap">{{ extra_days|round(1) }} days remaining</div>
                        {% endif %}
                        <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                          <input type="hidden" name="action" value="refill">
                          <input type="hidden" name="container_key" value="extra_{{ entry.id }}">
                          <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                        </form>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
        {% if tank.use_nopox or tank.nopox_daily_ml is not none %}
          {% set nopox_remaining = tank.nopox_remaining_ml if tank.nopox_remaining_ml is not none else tank.nopox_container_ml %}
          {% set nopox_pct = (nopox_remaining / tank.nopox_container_ml * 100) if tank.nopox_container_ml else none %}
          {% if nopox_pct is not none and nopox_pct > 100 %}{% set nopox_pct = 100 %}{% endif %}
          {% if nopox_pct is not none and nopox_pct < 0 %}{% set nopox_pct = 0 %}{% endif %}
          {% set nopox_days = (nopox_remaining / tank.nopox_daily_ml) if (nopox_remaining is not none and tank.nopox_daily_ml) else none %}
          {% set nopox_color = "var(--bs-primary)" %}
          {% if nopox_pct is not none and nopox_pct <= 20 %}{% set nopox_color = "var(--bs-danger)" %}{% elif nopox_pct is not none and nopox_pct <= 50 %}{% set nopox_color = "var(--bs-warning)" %}{% endif %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">NoPox</div>
                <div class="fw-semibold dose-solution-name">Red Sea NoPox</div>
                <div class="text-secondary small">{{ tank.nopox_daily_ml|fmt2 }} ml/day</div>
                {% if tank.nopox_container_ml %}
                  <div class="d-flex align-items-start gap-2 mt-2">
                    <div class="dose-container">
                      <div class="dose-liquid" style="height: {{ nopox_pct }}%; background: {{ nopox_color }};"></div>
                      <div class="dose-markings"></div>
                    </div>
                    <div>
                      <div class="text-muted small">{{ nopox_remaining|fmt2 }} / {{ tank.nopox_container_ml|fmt2 }} ml</div>
                      {% if nopox_days is not none %}
                        <div class="text-muted small text-nowrap">{{ nopox_days|round(1) }} days remaining</div>
                      {% endif %}
                      <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                        <input type="hidden" name="action" value="refill">
                        <input type="hidden" name="container_key" value="nopox">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
  </div>
  {% if daily_consumption %}
  <div class="mb-5">
    <div class="text-muted text-uppercase small fw-semibold mb-2">Estimated Daily Consumption</div>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
      {% for param_name, entry in daily_consumption|dictsort %}
        <div class="col">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">{{ param_name }}</div>
                <div class="fw-bold fs-5 text-dark">{{ entry.value|round(4) }} {{ entry.unit }}/day</div>
              </div>
              {% if entry.sources %}
                <div class="mt-2 text-muted small">
                  {% for source in entry.sources %}
                    <div>{{ source.label }}: {{ source.value|round(4) }} {{ source.unit }}/day</div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
{% endif %}

{% macro render_latest(title, param_list, show_hint=True) %}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h4 class="mb-0 h5 fw-bold">{{ title }}</h4>
    {% if show_hint %}
      <span class="text-muted small">Stability scores use the last 10 readings.</span>
    {% endif %}
  </div>
  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-5">
  {% for p in param_list %}
    {% set p_data = latest_vals.get(p.id) %}
    {% set val = p_data.value if p_data else None %}
    {% set taken_at = p_data.taken_at if p_data else None %}
    {% set sample_id = p_data.sample_id if p_data else None %}
    {% set target = target_map.get(p.name) %}
    
    {% set status_class = "border-secondary-subtle" %}
    {% if val is not none and target %}
        {# 1. Danger State (Red) - Outside Alert Range #}
        {% if (target.alert_low and val < target.alert_low) or (target.alert_high and val > target.alert_high) %}
            {% set status_class = "border-danger bg-danger-subtle text-danger" %}
        
        {# 2. Optimal State (Green) - Inside Target Range #}
        {% elif (target.target_low and target.target_high and val >= target.target_low and val <= target.target_high) %}
            {% set status_class = "border-success bg-success-subtle text-success" %}
            
        {# 3. Warning State (Yellow) - Between Target and Alert #}
        {% else %}
            {% set status_class = "border-warning bg-warning-subtle" %}
        {% endif %}
    {% endif %}

    <div class="col">
      <div class="card h-100 {{ status_class }} shadow-sm position-relative">
        {% if sample_id %}
          <a class="stretched-link" href="/tanks/{{ tank.id }}/samples/{{ sample_id }}" aria-label="View {{ p.name }} reading"></a>
        {% endif %}
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
             <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">{{ p.name }}</div>
             {% if taken_at %}
                <span class="badge bg-light text-secondary border fw-normal" style="font-size: 0.65rem;">
                   {{ taken_at|time_ago }}
                </span>
             {% endif %}
          </div>
          
          <div class="d-flex align-items-baseline gap-1 mt-2">
             <span class="h3 mb-0 fw-bold">{{ val|fmt2 if val is not none else "-" }}</span>
             <span class="text-muted small">{{ p.unit }}</span>
          </div>
          <div class="mt-2 d-flex flex-wrap gap-1 align-items-center">
            {% if stability_score_by_param.get(p.name) is not none %}
              <span class="badge text-bg-light border" data-bs-toggle="tooltip" data-bs-title="Stability is calculated from the last 10 readings. At least two readings are required.">Stability {{ stability_score_by_param.get(p.name)|round(0)|int }}%</span>
            {% else %}
              <span class="badge text-bg-light border" data-bs-toggle="tooltip" data-bs-title="Stability is calculated from the last 10 readings. At least two readings are required.">Stability —</span>
            {% endif %}
            {% if trend_warning_by_param.get(p.id) %}
              <span class="badge text-bg-warning">Rapid change</span>
            {% endif %}
            {% if overdue_by_param.get(p.id) %}
              <span class="badge text-bg-info">Overdue</span>
            {% endif %}
            {% if val is not none and target and target.target_low and val < target.target_low %}
              {% set deficit = target.target_low - val %}
              <a class="badge rounded-pill bg-primary-subtle text-primary-emphasis border position-relative z-1 text-decoration-none" href="/tools/dose-plan?tank_id={{ tank.id }}&parameter={{ p.name|replace(' ', '%20') }}">
                Dose plan: +{{ deficit|fmt2 }} {{ p.unit }}
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
{% endmacro %}

{% if trend_alert_params %}
  <div class="alert alert-warning small mb-4">
    <div class="fw-semibold">Trend alerts</div>
    <div>Rapid changes detected in: {{ trend_alert_params|join(", ") }}.</div>
  </div>
{% endif %}

{{ render_latest("Latest Readings", core_params) }}

{% if trace_params %}
  {{ render_latest("Trace Elements", trace_params, False) }}
{% endif %}

{% if icp_params %}
  {{ render_latest("ICP Results", icp_params, False) }}
{% endif %}

<div class="card shadow-sm mb-4">
  <div class="card-header bg-white py-3 d-flex flex-column gap-2">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 w-100">
      <h5 class="card-title mb-0 fw-bold">Trend Analysis</h5>
      <a class="btn btn-outline-secondary btn-sm" href="/tanks/{{ tank.id }}/targets">
        <i class="bi bi-sliders"></i> Edit Target Range
      </a>
    </div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="dropdown">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-graph-up"></i> Choose parameters
        </button>
        <div class="dropdown-menu p-3" style="min-width: 240px; max-height: 320px; overflow-y: auto;">
          <div class="small text-muted mb-2">Select up to 3 parameters</div>
          {% for p in params %}
            {% set param_key = p.key %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="trend-param" data-param-toggle data-label="{{ p.name }}" value="{{ param_key }}" id="param-{{ param_key }}" {% if selected_parameter_id == p.name %}checked{% endif %}>
              <label class="form-check-label small" for="param-{{ param_key }}">{{ p.name }}</label>
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="toggle-dose-events" checked>
        <label class="form-check-label small" for="toggle-dose-events">Show dosing events</label>
      </div>
      <div class="text-muted small" id="trendParamSummary">Compare up to 3 parameters at once.</div>
    </div>
  </div>
  <div class="card-body">
    <div style="height: 350px;">
      <canvas id="historyChart" data-tank-id="{{ tank.id }}"></canvas>
    </div>
    <div class="d-flex flex-column gap-2 text-muted small mt-3" id="historyStats" aria-live="polite"></div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h5 class="card-title mb-0 fw-bold">Recent Logs</h5>
    <a class="btn btn-outline-secondary btn-sm" href="/tanks/{{ tank.id }}/samples">
      <i class="bi bi-list"></i> View All
    </a>
  </div>

  <div class="d-md-none">
    <div class="list-group list-group-flush">
      {% for s in recent_samples %}
        <a class="list-group-item list-group-item-action" href="/tanks/{{ tank.id }}/samples/{{ s.id }}">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-medium text-navy">{{ s.taken_at|dtfmt }}</div>
            <form action="/samples/{{ s.id }}/delete" method="post" onsubmit="return confirm('Really delete this log?');" class="ms-2">
              <button class="btn btn-sm btn-outline-danger" type="submit" title="Delete reading">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </div>
          <div class="mt-2 d-flex flex-wrap gap-2">
            {% for p in params %}
              {% if p.name not in ['Temperature', 'Salinity'] %}
                {% set sv = sample_values.get(s.id, {}) %}
                {% set val = sv.get(p.id) %}
                <span class="badge bg-light text-dark border">
                  {{ p.name }}:
                  {% if val is not none %}
                    {{ val|fmt2 }} {{ p.unit }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              {% endif %}
            {% endfor %}
          </div>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="table-responsive d-none d-md-block">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th class="ps-3">Date</th>
          {% for p in params %}
            {% if p.name not in ['Temperature', 'Salinity'] %}
                <th class="text-center">{{ p.name }}</th>
            {% endif %}
          {% endfor %}
          <th class="text-end pe-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in recent_samples %}
          <tr style="cursor: pointer;" onclick="window.location.href='/tanks/{{ tank.id }}/samples/{{ s.id }}'">
            <td class="fw-medium ps-3 text-navy">{{ s.taken_at|dtfmt }}</td>
            
            {% for p in params %}
              {% if p.name not in ['Temperature', 'Salinity'] %}
                  <td class="text-center">
                     {% set sv = sample_values.get(s.id, {}) %}
                     {% set val = sv.get(p.id) %}
                     
                     {% if val is not none %}
                        <span class="fw-bold">{{ val|fmt2 }}</span> <small class="text-muted" style="font-size: 0.75em;">{{ p.unit }}</small>
                     {% else %}
                        <span class="text-muted">-</span>
                     {% endif %}
                  </td>
              {% endif %}
            {% endfor %}
            <td class="text-end pe-3" onclick="event.stopPropagation()">
                <form action="/samples/{{ s.id }}/delete" method="post" onsubmit="return confirm('Really delete this log?');" class="d-inline">
                    <button class="btn btn-link btn-sm text-danger p-0" type="submit" title="Delete reading">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      try {
          const seriesMap = {{ series_map|tojson|safe }};
          const targets = {{ chart_targets_map|tojson|safe }};
          const paramsMeta = {{ params|tojson|safe }};
          const doseLogEvents = {{ dose_log_events|tojson|safe }};
          const stabilityScores = {{ stability_score_by_param|tojson|safe }};
          const ctx = document.getElementById('historyChart');
          const paramToggles = Array.from(document.querySelectorAll('[data-param-toggle]'));
          const showDoseToggle = document.getElementById('toggle-dose-events');
          const tankId = ctx?.dataset?.tankId;
          const storageKey = tankId ? `reef-trend-params-${tankId}` : 'reef-trend-params';
          
          if (!ctx) return;

          if (typeof Chart === 'undefined') {
              throw new Error("Chart.js not found");
          }

          if (!seriesMap || Object.keys(seriesMap).length === 0) {
              const c = ctx.getContext('2d');
              c.font = "14px sans-serif";
              c.fillStyle = "#6c757d";
              c.textAlign = "center";
              c.fillText("No data available for these parameters.", ctx.width / 2, ctx.height / 2);
              return; 
          }

          function normalizeKey(value) {
            return String(value || '').toLowerCase().replace(/[\s/_-]+/g, '');
          }

          const normalizedSeriesMap = {};
          Object.keys(seriesMap).forEach((key) => {
            normalizedSeriesMap[normalizeKey(key)] = { key, series: seriesMap[key] || [] };
          });
          const unitsByKey = {};
          if (Array.isArray(paramsMeta)) {
            paramsMeta.forEach((param) => {
              unitsByKey[normalizeKey(param.name)] = param.unit || '';
            });
          }
          const stabilityByKey = {};
          if (stabilityScores) {
            Object.keys(stabilityScores).forEach((key) => {
              stabilityByKey[normalizeKey(key)] = stabilityScores[key];
            });
          }

          function cleanDate(dStr) {
              if (!dStr) return new Date();
              let s = String(dStr).split('.')[0].replace(" ", "T");
              let d = new Date(s);
              return isNaN(d.getTime()) ? new Date() : d;
          }

          const palette = ['#00d2d3', '#54a0ff', '#10ac84', '#feca57', '#ee5253', '#576574', '#5f27cd'];

          function formatLabel(date) {
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
          }

          function buildLabels(selectedParams) {
            const labelMap = new Map();
            selectedParams.forEach((key) => {
              const entry = normalizedSeriesMap[key];
              (entry ? entry.series : []).forEach((d) => {
                const date = cleanDate(d.x);
                labelMap.set(date.getTime(), date);
              });
            });
            if (doseLogEvents && doseLogEvents.length) {
              doseLogEvents.forEach((event) => {
                if (!selectedParams.includes(normalizeKey(event.parameter))) {
                  return;
                }
                const date = cleanDate(event.logged_at);
                labelMap.set(date.getTime(), date);
              });
            }
            const sorted = Array.from(labelMap.entries()).sort((a, b) => a[0] - b[0]);
            return sorted.map((entry) => formatLabel(entry[1]));
          }

          function axisAssignments(selectedParams) {
            const unitToAxis = {};
            const axisOrder = [];
            selectedParams.forEach((key) => {
              const unit = unitsByKey[key] || (targets && targets[key] ? (targets[key].unit || '') : '');
              if (!Object.prototype.hasOwnProperty.call(unitToAxis, unit)) {
                unitToAxis[unit] = `y${axisOrder.length}`;
                axisOrder.push(unit);
              }
            });
            return { unitToAxis, axisOrder };
          }

          function buildAxes(axisOrder) {
            const axes = {};
            axisOrder.forEach((unit, index) => {
              axes[`y${index}`] = {
                type: 'linear',
                position: index === 0 ? 'left' : 'right',
                grid: index === 0 ? { borderDash: [2, 4], color: '#e9ecef' } : { drawOnChartArea: false },
                title: unit ? { display: true, text: unit } : { display: false }
              };
            });
            return axes;
          }

          function buildDatasets(selectedParams, labels, unitToAxis) {
            const datasets = [];
            selectedParams.forEach((key, index) => {
              const entry = normalizedSeriesMap[key];
              const series = entry ? entry.series : [];
              const label = entry?.key || key;
              const unit = unitsByKey[key] || (targets && targets[key] ? (targets[key].unit || '') : '');
              const yAxisID = unitToAxis[unit] || 'y0';
              const labelIndex = new Map();
              labels.forEach((label, idx) => labelIndex.set(label, idx));
              const dataPoints = Array(labels.length).fill(null);
              series.forEach((d) => {
                const date = cleanDate(d.x);
                const label = formatLabel(date);
                const idx = labelIndex.get(label);
                if (idx !== undefined) {
                  dataPoints[idx] = d.y;
                }
              });
              datasets.push({
                label: label,
                data: dataPoints,
                yAxisID: yAxisID,
                borderColor: palette[index % palette.length],
                backgroundColor: 'rgba(0, 210, 211, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: false,
                spanGaps: true,
                pointRadius: 3
              });
            });
            return datasets;
          }

          function buildAnnotations(selectedParams) {
            if (selectedParams.length !== 1 || !targets || Object.keys(targets).length === 0) {
              return buildDoseAnnotations(selectedParams);
            }
            const t = targets[selectedParams[0]];
            if (!t) {
              return buildDoseAnnotations(selectedParams);
            }
            const annotations = {};
            if (t.target_low !== null && t.target_high !== null) {
              annotations.targetRange = {
                type: 'box',
                yMin: t.target_low,
                yMax: t.target_high,
                backgroundColor: 'rgba(29, 209, 161, 0.15)',
                borderWidth: 0,
                label: {
                  display: true,
                  content: 'Target Range',
                  position: 'end',
                  color: '#10ac84',
                  font: { size: 10, weight: 'bold' }
                }
              };
            }
            if (t.alert_low !== null && typeof t.alert_low !== 'undefined') {
              annotations.alertLow = {
                type: 'line',
                yMin: t.alert_low,
                yMax: t.alert_low,
                borderColor: '#ff7675',
                borderWidth: 2,
                borderDash: [6, 6],
                label: {
                  display: true,
                  content: 'Low Alert: ' + t.alert_low,
                  position: 'start',
                  backgroundColor: '#ff7675',
                  color: 'white',
                  font: { size: 10 }
                }
              };
            }
            if (t.alert_high !== null && typeof t.alert_high !== 'undefined') {
              annotations.alertHigh = {
                type: 'line',
                yMin: t.alert_high,
                yMax: t.alert_high,
                borderColor: '#ff7675',
                borderWidth: 2,
                borderDash: [6, 6],
                label: {
                  display: true,
                  content: 'High Alert: ' + t.alert_high,
                  position: 'start',
                  backgroundColor: '#ff7675',
                  color: 'white',
                  font: { size: 10 }
                }
              };
            }
            return buildDoseAnnotations(selectedParams, annotations);
          }

          function buildDoseAnnotations(selectedParams, annotations = {}) {
            if (!showDoseToggle || !showDoseToggle.checked || !doseLogEvents || !doseLogEvents.length) {
              return annotations;
            }
            let index = 0;
            const matching = doseLogEvents.filter((event) => selectedParams.includes(normalizeKey(event.parameter)));
            const showLabels = matching.length <= 5;
            matching.forEach((event) => {
              const date = cleanDate(event.logged_at);
              const label = formatLabel(date);
              annotations[`dose-${index}`] = {
                type: 'line',
                xMin: label,
                xMax: label,
                borderColor: '#6366f1',
                borderWidth: 1,
                borderDash: [4, 4],
                label: {
                  display: showLabels,
                  content: `${event.label || 'Dose'} (${Number(event.amount_ml || 0).toFixed(1)} ml)`,
                  position: 'start',
                  backgroundColor: '#6366f1',
                  color: 'white',
                  font: { size: 9 }
                }
              };
              index += 1;
            });
            return annotations;
          }

          function selectedParams() {
            let checked = paramToggles.filter((box) => box.checked).map((box) => box.value);
            if (checked.length === 0 && paramToggles.length > 0) {
              paramToggles[0].checked = true;
              checked = [paramToggles[0].value];
            }
            return checked.slice(0, 3);
          }

          function updateParamSummary(selected) {
            const summaryEl = document.getElementById('trendParamSummary');
            if (!summaryEl) return;
            if (!selected.length) {
              summaryEl.textContent = 'Compare up to 3 parameters at once.';
              return;
            }
            const labels = paramToggles
              .filter((box) => selected.includes(box.value))
              .map((box) => box.dataset.label || box.value);
            summaryEl.textContent = `Showing ${labels.join(', ')} (${selected.length}/3).`;
          }

          function restoreSelection() {
            if (!paramToggles.length) return;
            let stored = [];
            try {
              const raw = window.localStorage.getItem(storageKey);
              stored = raw ? JSON.parse(raw) : [];
            } catch (err) {
              stored = [];
            }
            if (!Array.isArray(stored) || stored.length === 0) return;
            const valid = new Set(paramToggles.map((box) => box.value));
            const filtered = stored.filter((key) => valid.has(key));
            if (!filtered.length) return;
            paramToggles.forEach((box) => {
              box.checked = filtered.includes(box.value);
            });
          }

          function persistSelection() {
            try {
              window.localStorage.setItem(storageKey, JSON.stringify(selectedParams()));
            } catch (err) {
              // ignore
            }
          }

          function formatNumber(value) {
            if (value === null || typeof value === 'undefined') return '—';
            if (typeof value !== 'number') return value;
            return value.toFixed(2);
          }

          function renderChart() {
            const selected = selectedParams();
            updateParamSummary(selected);
            const labels = buildLabels(selected);
            const { unitToAxis, axisOrder } = axisAssignments(selected);
            const datasets = buildDatasets(selected, labels, unitToAxis);
            const annotations = buildAnnotations(selected);
            const statsEl = document.getElementById('historyStats');

            if (!labels.length || datasets.length === 0) {
              const c = ctx.getContext('2d');
              c.clearRect(0, 0, ctx.width, ctx.height);
              c.font = "14px sans-serif";
              c.fillStyle = "#6c757d";
              c.textAlign = "center";
              c.fillText("No data available for these parameters.", ctx.width / 2, ctx.height / 2);
              if (statsEl) {
                statsEl.innerHTML = '<div>—</div>';
              }
              return;
            }

            if (statsEl) {
              statsEl.innerHTML = '';
              datasets.forEach((dataset) => {
                const values = (dataset?.data || []).filter((v) => v !== null && typeof v !== 'undefined');
                let min = null;
                let max = null;
                let median = null;
                if (values.length) {
                  const sorted = [...values].sort((a, b) => a - b);
                  min = sorted[0];
                  max = sorted[sorted.length - 1];
                  const mid = Math.floor(sorted.length / 2);
                  median = sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
                }
                const label = dataset?.label || '—';
                const stability = stabilityByKey[normalizeKey(label)];
                const row = document.createElement('div');
                row.className = 'd-flex flex-wrap align-items-center gap-3';
                row.innerHTML = `
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle" style="width:10px; height:10px; background: ${dataset?.borderColor || '#6c757d'};"></span>
                    <span class="fw-semibold text-dark">${label}</span>
                  </div>
                  <div><span class="fw-semibold text-dark">Min:</span> ${formatNumber(min)}</div>
                  <div><span class="fw-semibold text-dark">Median:</span> ${formatNumber(median)}</div>
                  <div><span class="fw-semibold text-dark">Max:</span> ${formatNumber(max)}</div>
                  <div><span class="fw-semibold text-dark">Stability:</span> ${stability !== null && typeof stability !== 'undefined' ? Math.round(stability) + '%' : '—'}</div>
                `;
                statsEl.appendChild(row);
              });
            }

            const existingChart = window.historyChart && typeof window.historyChart.destroy === 'function'
              ? window.historyChart
              : Chart.getChart(ctx);
            if (existingChart) {
              existingChart.destroy();
            }

            window.historyChart = new Chart(ctx, {
              type: 'line',
              data: { labels, datasets },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                  legend: { display: true, position: 'bottom' },
                  annotation: { annotations }
                },
                scales: {
                  ...buildAxes(axisOrder),
                  x: { display: false }
                }
              }
            });
          }

          paramToggles.forEach((box) => {
            box.addEventListener('change', (event) => {
              const checked = paramToggles.filter((item) => item.checked);
              if (checked.length > 3 && event && event.target) {
                event.target.checked = false;
              }
              persistSelection();
              renderChart();
            });
          });
          if (showDoseToggle) {
            showDoseToggle.addEventListener('change', renderChart);
          }

          restoreSelection();
          persistSelection();
          renderChart();
      } catch (err) {
          console.error("Chart Error:", err);
      }
  });
</script>
{% endblock %}
        {% if tank.use_calcium_reactor or tank.calcium_reactor_daily_ml is not none or tank.calcium_reactor_effluent_dkh is not none %}
          <div class="col">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body p-3">
                <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">Calcium Reactor</div>
                <div class="fw-semibold">Effluent</div>
                <div class="text-secondary small">{{ tank.calcium_reactor_daily_ml|fmt2 if tank.calcium_reactor_daily_ml is not none else "—" }} ml/day</div>
                <div class="text-secondary small">{{ tank.calcium_reactor_effluent_dkh|fmt2 if tank.calcium_reactor_effluent_dkh is not none else "—" }} dKH effluent</div>
              </div>
            </div>
          </div>
        {% endif %}
