{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
  <div>
    <h1 class="h2 mb-0 fw-bold">{{ tank.name }}</h1>
    <div class="text-muted small d-flex gap-3 align-items-center mt-1">
      <span>ID: {{ tank.id }}</span>
      {% if tank.volume_l %}
        <span class="badge bg-light text-secondary border fs-6">{{ tank.volume_l }} Liters</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-success" href="/tanks/{{ tank.id }}/export"><i class="bi bi-download"></i> Export</a>
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}/dosing-log">Dosing Log</a>
    <a class="btn btn-primary" href="/tanks/{{ tank.id }}/add">Log Test</a>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Settings</button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/targets">Targets</a></li>
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/profile">Edit Profile</a></li>
        <li><hr class="dropdown-divider"></li>
        <li>
             <form method="post" action="/tanks/{{ tank.id }}/delete" onsubmit="return confirm('Really delete?');" class="d-inline">
                <button class="dropdown-item text-danger" type="submit">Delete Tank</button>
             </form>
        </li>
      </ul>
    </div>
  </div>
</div>

<h4 class="mb-3">Latest Readings</h4>
<div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-5">
  {% for p in params %}
    {% set p_data = latest_vals.get(p.id) %}
    {% set val = p_data.value if p_data else None %}
    {% set taken_at = p_data.taken_at if p_data else None %}
    {% set target = target_map.get(p.name) %}
    
    {% set status_class = "border-secondary-subtle" %}
    {% if val is not none and target %}
        {% if target.alert_low and val < target.alert_low %}{% set status_class = "border-danger bg-danger-subtle" %}{% endif %}
        {% if target.alert_high and val > target.alert_high %}{% set status_class = "border-danger bg-danger-subtle" %}{% endif %}
    {% endif %}

    <div class="col">
      <div class="card h-100 {{ status_class }} shadow-sm">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
             <div class="text-muted small text-uppercase fw-bold">{{ p.name }}</div>
             {% if taken_at %}<span class="badge bg-light text-secondary border fw-normal" style="font-size: 0.65rem;">{{ taken_at|time_ago }}</span>{% endif %}
          </div>
          <div class="d-flex align-items-baseline gap-1 mt-2">
             <span class="h3 mb-0 fw-bold">{{ val|fmt2 if val is not none else "-" }}</span>
             <span class="text-muted small">{{ p.unit }}</span>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">History</h5>
    <form method="get" class="d-flex align-items-center gap-2">
      <select name="parameter" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for p in params %}
          <option value="{{ p.id }}" {% if selected_parameter_id == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
  <div class="card-body">
    <div style="height: 350px;"><canvas id="historyChart"></canvas></div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white"><h5 class="card-title mb-0">Log</h5></div>
  <div class="table-responsive">
    <table class="table table-hover mb-0 align-middle text-nowrap">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          {% for p in params %}
            {% if p.name not in ['Temperature', 'Salinity'] %}<th class="text-center">{{ p.name }}</th>{% endif %}
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for s in recent_samples %}
          <tr style="cursor: pointer;" onclick="window.location.href='/tanks/{{ tank.id }}/samples/{{ s.id }}'">
            <td class="fw-medium">{{ s.taken_at|dtfmt }}</td>
            {% for p in params %}
              {% if p.name not in ['Temperature', 'Salinity'] %}
                  <td class="text-center">
                     {% set sv = sample_values.get(s.id, {}) %}{% set val = sv.get(p.id) %}
                     {% if val is not none %}{{ val|fmt2 }} <small class="text-muted" style="font-size: 0.75em;">{{ p.unit }}</small>
                     {% else %}<span class="text-muted">-</span>{% endif %}
                  </td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      try {
          const seriesData = {{ series|tojson|safe }};
          const targets = {{ chart_targets|tojson|safe }};
          const ctx = document.getElementById('historyChart');
          if (!ctx) return;
          if (!seriesData || seriesData.length === 0) return;

          function cleanDate(dStr) {
              if (!dStr) return new Date();
              return new Date(String(dStr).split('.')[0].replace(" ", "T"));
          }

          const labels = seriesData.map(d => {
            const date = cleanDate(d.x);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          });
          
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Reading',
                data: seriesData.map(d => d.y),
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 4
              }]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: false }, x: { display: false } }
            }
          });
      } catch (err) { console.error(err); }
  });
</script>
{% endblock %}
