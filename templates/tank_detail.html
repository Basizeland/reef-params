{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
  <div>
    <h1 class="h2 mb-0 fw-bold text-navy">{{ tank.name }}</h1>
    <div class="text-muted small d-flex gap-3 align-items-center mt-1">
      <span>ID: {{ tank.id }}</span>
      {% if tank.volume_l %}
        <span class="badge bg-light text-secondary border fs-6">{{ tank.volume_l }} Liters</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-success" href="/tanks/{{ tank.id }}/export">
        <i class="bi bi-file-earmark-spreadsheet"></i> Export Excel
    </a>
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}/journal">
      <i class="bi bi-journal-text"></i> Journal
    </a>
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}/dosing-log">Dosing Log</a>
    <a class="btn btn-primary" href="/tanks/{{ tank.id }}/add">Log Test</a>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Settings
      </button>
      <ul class="dropdown-menu dropdown-menu-end shadow-sm">
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/targets">Targets</a></li>
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/profile">Edit Profile</a></li>
        <li><hr class="dropdown-divider"></li>
        <li>
             <form method="post" action="/tanks/{{ tank.id }}/delete" onsubmit="return confirm('Really delete?');" class="d-inline">
                <button class="dropdown-item text-danger" type="submit">Delete Tank</button>
             </form>
        </li>
      </ul>
    </div>
  </div>
</div>

{% set has_dosing = tank.dosing_mode or tank.all_in_one_solution or tank.alk_solution or tank.ca_solution or tank.mg_solution or tank.nitrate_solution or tank.phosphate_solution or tank.nopox_daily_ml or tank.all_in_one_daily_ml or tank.alk_daily_ml or tank.ca_daily_ml or tank.mg_daily_ml or tank.nitrate_daily_ml or tank.phosphate_daily_ml %}
{% if has_dosing %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3">
      <h5 class="card-title mb-0 fw-bold">Daily Dosing</h5>
    </div>
    <div class="card-body">
      <div class="mb-3 text-muted small">
        Mode: {{ tank.dosing_mode|replace('_', ' ')|title if tank.dosing_mode else "Not specified" }}
      </div>
      <div class="row g-3">
        {% if (tank.dosing_mode == 'all_in_one' or not tank.dosing_mode) and (tank.all_in_one_solution or tank.all_in_one_daily_ml) %}
          {% set all_in_one_remaining = tank.all_in_one_remaining_ml if tank.all_in_one_remaining_ml is not none else tank.all_in_one_container_ml %}
          {% set all_in_one_pct = (all_in_one_remaining / tank.all_in_one_container_ml * 100) if tank.all_in_one_container_ml else none %}
          {% if all_in_one_pct is not none and all_in_one_pct > 100 %}{% set all_in_one_pct = 100 %}{% endif %}
          {% if all_in_one_pct is not none and all_in_one_pct < 0 %}{% set all_in_one_pct = 0 %}{% endif %}
          <div class="col-12 col-md-4">
            <div class="text-muted small">All-in-one</div>
            <div class="fw-semibold">{{ tank.all_in_one_solution or "—" }}</div>
            <div class="text-secondary small">{{ tank.all_in_one_daily_ml|fmt2 if tank.all_in_one_daily_ml is not none else "—" }} ml/day</div>
            {% if tank.all_in_one_container_ml %}
              <div class="d-flex align-items-end gap-3 mt-2">
                <div class="rounded border bg-light" style="width: 28px; height: 90px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: repeating-linear-gradient(to top, rgba(0, 0, 0, 0.08) 0 2px, rgba(0, 0, 0, 0) 2px 10px);">
                  <div style="width: 100%; height: {{ all_in_one_pct }}%; background: repeating-linear-gradient(to top, rgba(255, 255, 255, 0.35) 0 2px, rgba(255, 255, 255, 0) 2px 10px), var(--bs-primary);"></div>
                </div>
                <div>
                  <div class="text-muted small">{{ all_in_one_remaining|fmt2 }} / {{ tank.all_in_one_container_ml|fmt2 }} ml</div>
                  <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                    <input type="hidden" name="action" value="refill">
                    <input type="hidden" name="container_key" value="all_in_one">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if (tank.dosing_mode in ['two_part', 'three_part'] or not tank.dosing_mode) and (tank.alk_solution or tank.alk_daily_ml is not none) %}
          {% set alk_remaining = tank.alk_remaining_ml if tank.alk_remaining_ml is not none else tank.alk_container_ml %}
          {% set alk_pct = (alk_remaining / tank.alk_container_ml * 100) if tank.alk_container_ml else none %}
          {% if alk_pct is not none and alk_pct > 100 %}{% set alk_pct = 100 %}{% endif %}
          {% if alk_pct is not none and alk_pct < 0 %}{% set alk_pct = 0 %}{% endif %}
          <div class="col-12 col-md-4">
            <div class="text-muted small">Alkalinity</div>
            <div class="fw-semibold">{{ tank.alk_solution or "—" }}</div>
            <div class="text-secondary small">{{ tank.alk_daily_ml|fmt2 if tank.alk_daily_ml is not none else "—" }} ml/day</div>
            {% if tank.alk_container_ml %}
              <div class="d-flex align-items-end gap-3 mt-2">
                <div class="rounded border bg-light" style="width: 28px; height: 90px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: repeating-linear-gradient(to top, rgba(0, 0, 0, 0.08) 0 2px, rgba(0, 0, 0, 0) 2px 10px);">
                  <div style="width: 100%; height: {{ alk_pct }}%; background: repeating-linear-gradient(to top, rgba(255, 255, 255, 0.35) 0 2px, rgba(255, 255, 255, 0) 2px 10px), var(--bs-primary);"></div>
                </div>
                <div>
                  <div class="text-muted small">{{ alk_remaining|fmt2 }} / {{ tank.alk_container_ml|fmt2 }} ml</div>
                  <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                    <input type="hidden" name="action" value="refill">
                    <input type="hidden" name="container_key" value="alk">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if (tank.dosing_mode in ['two_part', 'three_part'] or not tank.dosing_mode) and (tank.ca_solution or tank.ca_daily_ml is not none) %}
          {% set ca_remaining = tank.ca_remaining_ml if tank.ca_remaining_ml is not none else tank.ca_container_ml %}
          {% set ca_pct = (ca_remaining / tank.ca_container_ml * 100) if tank.ca_container_ml else none %}
          {% if ca_pct is not none and ca_pct > 100 %}{% set ca_pct = 100 %}{% endif %}
          {% if ca_pct is not none and ca_pct < 0 %}{% set ca_pct = 0 %}{% endif %}
          <div class="col-12 col-md-4">
            <div class="text-muted small">Calcium</div>
            <div class="fw-semibold">{{ tank.ca_solution or "—" }}</div>
            <div class="text-secondary small">{{ tank.ca_daily_ml|fmt2 if tank.ca_daily_ml is not none else "—" }} ml/day</div>
            {% if tank.ca_container_ml %}
              <div class="d-flex align-items-end gap-3 mt-2">
                <div class="rounded border bg-light" style="width: 28px; height: 90px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: repeating-linear-gradient(to top, rgba(0, 0, 0, 0.08) 0 2px, rgba(0, 0, 0, 0) 2px 10px);">
                  <div style="width: 100%; height: {{ ca_pct }}%; background: repeating-linear-gradient(to top, rgba(255, 255, 255, 0.35) 0 2px, rgba(255, 255, 255, 0) 2px 10px), var(--bs-primary);"></div>
                </div>
                <div>
                  <div class="text-muted small">{{ ca_remaining|fmt2 }} / {{ tank.ca_container_ml|fmt2 }} ml</div>
                  <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                    <input type="hidden" name="action" value="refill">
                    <input type="hidden" name="container_key" value="ca">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if (tank.dosing_mode == 'three_part' or not tank.dosing_mode) and (tank.mg_solution or tank.mg_daily_ml is not none) %}
          {% set mg_remaining = tank.mg_remaining_ml if tank.mg_remaining_ml is not none else tank.mg_container_ml %}
          {% set mg_pct = (mg_remaining / tank.mg_container_ml * 100) if tank.mg_container_ml else none %}
          {% if mg_pct is not none and mg_pct > 100 %}{% set mg_pct = 100 %}{% endif %}
          {% if mg_pct is not none and mg_pct < 0 %}{% set mg_pct = 0 %}{% endif %}
          <div class="col-12 col-md-4">
            <div class="text-muted small">Magnesium</div>
            <div class="fw-semibold">{{ tank.mg_solution or "—" }}</div>
            <div class="text-secondary small">{{ tank.mg_daily_ml|fmt2 if tank.mg_daily_ml is not none else "—" }} ml/day</div>
            {% if tank.mg_container_ml %}
              <div class="d-flex align-items-end gap-3 mt-2">
                <div class="rounded border bg-light" style="width: 28px; height: 90px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: repeating-linear-gradient(to top, rgba(0, 0, 0, 0.08) 0 2px, rgba(0, 0, 0, 0) 2px 10px);">
                  <div style="width: 100%; height: {{ mg_pct }}%; background: repeating-linear-gradient(to top, rgba(255, 255, 255, 0.35) 0 2px, rgba(255, 255, 255, 0) 2px 10px), var(--bs-primary);"></div>
                </div>
                <div>
                  <div class="text-muted small">{{ mg_remaining|fmt2 }} / {{ tank.mg_container_ml|fmt2 }} ml</div>
                  <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                    <input type="hidden" name="action" value="refill">
                    <input type="hidden" name="container_key" value="mg">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if tank.nitrate_solution or tank.nitrate_daily_ml is not none %}
          {% set nitrate_remaining = tank.nitrate_remaining_ml if tank.nitrate_remaining_ml is not none else tank.nitrate_container_ml %}
          {% set nitrate_pct = (nitrate_remaining / tank.nitrate_container_ml * 100) if tank.nitrate_container_ml else none %}
          {% if nitrate_pct is not none and nitrate_pct > 100 %}{% set nitrate_pct = 100 %}{% endif %}
          {% if nitrate_pct is not none and nitrate_pct < 0 %}{% set nitrate_pct = 0 %}{% endif %}
          <div class="col-12 col-md-4">
            <div class="text-muted small">Nitrate</div>
            <div class="fw-semibold">{{ tank.nitrate_solution or "—" }}</div>
            <div class="text-secondary small">{{ tank.nitrate_daily_ml|fmt2 if tank.nitrate_daily_ml is not none else "—" }} ml/day</div>
            {% if tank.nitrate_container_ml %}
              <div class="d-flex align-items-end gap-3 mt-2">
                <div class="rounded border bg-light" style="width: 28px; height: 90px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: repeating-linear-gradient(to top, rgba(0, 0, 0, 0.08) 0 2px, rgba(0, 0, 0, 0) 2px 10px);">
                  <div style="width: 100%; height: {{ nitrate_pct }}%; background: repeating-linear-gradient(to top, rgba(255, 255, 255, 0.35) 0 2px, rgba(255, 255, 255, 0) 2px 10px), var(--bs-primary);"></div>
                </div>
                <div>
                  <div class="text-muted small">{{ nitrate_remaining|fmt2 }} / {{ tank.nitrate_container_ml|fmt2 }} ml</div>
                  <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                    <input type="hidden" name="action" value="refill">
                    <input type="hidden" name="container_key" value="nitrate">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if tank.phosphate_solution or tank.phosphate_daily_ml is not none %}
          {% set phosphate_remaining = tank.phosphate_remaining_ml if tank.phosphate_remaining_ml is not none else tank.phosphate_container_ml %}
          {% set phosphate_pct = (phosphate_remaining / tank.phosphate_container_ml * 100) if tank.phosphate_container_ml else none %}
          {% if phosphate_pct is not none and phosphate_pct > 100 %}{% set phosphate_pct = 100 %}{% endif %}
          {% if phosphate_pct is not none and phosphate_pct < 0 %}{% set phosphate_pct = 0 %}{% endif %}
          <div class="col-12 col-md-4">
            <div class="text-muted small">Phosphate</div>
            <div class="fw-semibold">{{ tank.phosphate_solution or "—" }}</div>
            <div class="text-secondary small">{{ tank.phosphate_daily_ml|fmt2 if tank.phosphate_daily_ml is not none else "—" }} ml/day</div>
            {% if tank.phosphate_container_ml %}
              <div class="d-flex align-items-end gap-3 mt-2">
                <div class="rounded border bg-light" style="width: 28px; height: 90px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: repeating-linear-gradient(to top, rgba(0, 0, 0, 0.08) 0 2px, rgba(0, 0, 0, 0) 2px 10px);">
                  <div style="width: 100%; height: {{ phosphate_pct }}%; background: repeating-linear-gradient(to top, rgba(255, 255, 255, 0.35) 0 2px, rgba(255, 255, 255, 0) 2px 10px), var(--bs-primary);"></div>
                </div>
                <div>
                  <div class="text-muted small">{{ phosphate_remaining|fmt2 }} / {{ tank.phosphate_container_ml|fmt2 }} ml</div>
                  <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                    <input type="hidden" name="action" value="refill">
                    <input type="hidden" name="container_key" value="phosphate">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if tank.nopox_daily_ml is not none %}
          {% set nopox_remaining = tank.nopox_remaining_ml if tank.nopox_remaining_ml is not none else tank.nopox_container_ml %}
          {% set nopox_pct = (nopox_remaining / tank.nopox_container_ml * 100) if tank.nopox_container_ml else none %}
          {% if nopox_pct is not none and nopox_pct > 100 %}{% set nopox_pct = 100 %}{% endif %}
          {% if nopox_pct is not none and nopox_pct < 0 %}{% set nopox_pct = 0 %}{% endif %}
          <div class="col-12 col-md-4">
            <div class="text-muted small">NoPox</div>
            <div class="fw-semibold">Red Sea NoPox</div>
            <div class="text-secondary small">{{ tank.nopox_daily_ml|fmt2 }} ml/day</div>
            {% if tank.nopox_container_ml %}
              <div class="d-flex align-items-end gap-3 mt-2">
                <div class="rounded border bg-light" style="width: 28px; height: 90px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; background: repeating-linear-gradient(to top, rgba(0, 0, 0, 0.08) 0 2px, rgba(0, 0, 0, 0) 2px 10px);">
                  <div style="width: 100%; height: {{ nopox_pct }}%; background: repeating-linear-gradient(to top, rgba(255, 255, 255, 0.35) 0 2px, rgba(255, 255, 255, 0) 2px 10px), var(--bs-primary);"></div>
                </div>
                <div>
                  <div class="text-muted small">{{ nopox_remaining|fmt2 }} / {{ tank.nopox_container_ml|fmt2 }} ml</div>
                  <form method="post" action="/tanks/{{ tank.id }}/dosing-containers" class="mt-1">
                    <input type="hidden" name="action" value="refill">
                    <input type="hidden" name="container_key" value="nopox">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Refill</button>
                  </form>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}

<h4 class="mb-3 h5 fw-bold">Latest Readings</h4>
<div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-5">
  {% for p in params %}
    {% set p_data = latest_vals.get(p.id) %}
    {% set val = p_data.value if p_data else None %}
    {% set taken_at = p_data.taken_at if p_data else None %}
    {% set sample_id = p_data.sample_id if p_data else None %}
    {% set target = target_map.get(p.name) %}
    
    {% set status_class = "border-secondary-subtle" %}
    {% if val is not none and target %}
        {# 1. Danger State (Red) - Outside Alert Range #}
        {% if (target.alert_low and val < target.alert_low) or (target.alert_high and val > target.alert_high) %}
            {% set status_class = "border-danger bg-danger-subtle text-danger" %}
        
        {# 2. Optimal State (Green) - Inside Target Range #}
        {% elif (target.target_low and target.target_high and val >= target.target_low and val <= target.target_high) %}
            {% set status_class = "border-success bg-success-subtle text-success" %}
            
        {# 3. Warning State (Yellow) - Between Target and Alert #}
        {% else %}
            {% set status_class = "border-warning bg-warning-subtle" %}
        {% endif %}
    {% endif %}

    <div class="col">
      <div class="card h-100 {{ status_class }} shadow-sm position-relative">
        {% if sample_id %}
          <a class="stretched-link" href="/tanks/{{ tank.id }}/samples/{{ sample_id }}" aria-label="View {{ p.name }} reading"></a>
        {% endif %}
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
             <div class="text-muted small text-uppercase fw-bold" style="letter-spacing: 0.5px;">{{ p.name }}</div>
             {% if taken_at %}
                <span class="badge bg-light text-secondary border fw-normal" style="font-size: 0.65rem;">
                   {{ taken_at|time_ago }}
                </span>
             {% endif %}
          </div>
          
          <div class="d-flex align-items-baseline gap-1 mt-2">
             <span class="h3 mb-0 fw-bold">{{ val|fmt2 if val is not none else "-" }}</span>
             <span class="text-muted small">{{ p.unit }}</span>
          </div>
          <div class="mt-2 d-flex flex-wrap gap-1">
            {% if trend_warning_by_param.get(p.id) %}
              <span class="badge text-bg-warning">Rapid change</span>
            {% endif %}
            {% if overdue_by_param.get(p.id) %}
              <span class="badge text-bg-info">Overdue</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h5 class="card-title mb-0 fw-bold">Trend Analysis</h5>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/tanks/{{ tank.id }}/targets">
        <i class="bi bi-sliders"></i> Edit Target Range
      </a>
      <form method="get" class="d-flex align-items-center gap-2">
        <select name="parameter" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
          {% for p in params %}
            <option value="{{ p.id }}" {% if selected_parameter_id == p.id %}selected{% endif %}>
              {{ p.name }}
            </option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>
  <div class="card-body">
    <div style="height: 350px;">
      <canvas id="historyChart"></canvas>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white py-3">
    <h5 class="card-title mb-0 fw-bold">Recent Logs</h5>
  </div>

  <div class="d-md-none">
    <div class="list-group list-group-flush">
      {% for s in recent_samples %}
        <a class="list-group-item list-group-item-action" href="/tanks/{{ tank.id }}/samples/{{ s.id }}">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-medium text-navy">{{ s.taken_at|dtfmt }}</div>
            <form action="/samples/{{ s.id }}/delete" method="post" onsubmit="return confirm('Really delete this log?');" class="ms-2">
              <button class="btn btn-sm btn-outline-danger" type="submit" title="Delete reading">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </div>
          <div class="mt-2 d-flex flex-wrap gap-2">
            {% for p in params %}
              {% if p.name not in ['Temperature', 'Salinity'] %}
                {% set sv = sample_values.get(s.id, {}) %}
                {% set val = sv.get(p.id) %}
                <span class="badge bg-light text-dark border">
                  {{ p.name }}:
                  {% if val is not none %}
                    {{ val|fmt2 }} {{ p.unit }}
                  {% else %}
                    -
                  {% endif %}
                </span>
              {% endif %}
            {% endfor %}
          </div>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="table-responsive d-none d-md-block">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th class="ps-3">Date</th>
          {% for p in params %}
            {% if p.name not in ['Temperature', 'Salinity'] %}
                <th class="text-center">{{ p.name }}</th>
            {% endif %}
          {% endfor %}
          <th class="text-end pe-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in recent_samples %}
          <tr style="cursor: pointer;" onclick="window.location.href='/tanks/{{ tank.id }}/samples/{{ s.id }}'">
            <td class="fw-medium ps-3 text-navy">{{ s.taken_at|dtfmt }}</td>
            
            {% for p in params %}
              {% if p.name not in ['Temperature', 'Salinity'] %}
                  <td class="text-center">
                     {% set sv = sample_values.get(s.id, {}) %}
                     {% set val = sv.get(p.id) %}
                     
                     {% if val is not none %}
                        <span class="fw-bold">{{ val|fmt2 }}</span> <small class="text-muted" style="font-size: 0.75em;">{{ p.unit }}</small>
                     {% else %}
                        <span class="text-muted">-</span>
                     {% endif %}
                  </td>
              {% endif %}
            {% endfor %}
            <td class="text-end pe-3" onclick="event.stopPropagation()">
                <form action="/samples/{{ s.id }}/delete" method="post" onsubmit="return confirm('Really delete this log?');" class="d-inline">
                    <button class="btn btn-link btn-sm text-danger p-0" type="submit" title="Delete reading">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      try {
          const seriesData = {{ series|tojson|safe }};
          const targets = {{ chart_targets|tojson|safe }};
          const ctx = document.getElementById('historyChart');
          
          if (!ctx) return;

          if (typeof Chart === 'undefined') {
              throw new Error("Chart.js not found");
          }

          if (!seriesData || seriesData.length === 0) {
              const c = ctx.getContext('2d');
              c.font = "14px sans-serif";
              c.fillStyle = "#6c757d";
              c.textAlign = "center";
              c.fillText("No data available for this parameter.", ctx.width / 2, ctx.height / 2);
              return; 
          }

          function cleanDate(dStr) {
              if (!dStr) return new Date();
              let s = String(dStr).split('.')[0].replace(" ", "T");
              let d = new Date(s);
              return isNaN(d.getTime()) ? new Date() : d;
          }

          const labels = seriesData.map(d => {
            const date = cleanDate(d.x);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          });
          
          const dataPoints = seriesData.map(d => d.y);
          const pointColors = seriesData.map(d => {
            const val = d.y;
            if (!targets || targets.length === 0 || val === null || typeof val === 'undefined') {
              return '#042f4b';
            }
            const t = targets[0];
            const alertLow = t.alert_low;
            const alertHigh = t.alert_high;
            const targetLow = t.target_low;
            const targetHigh = t.target_high;
            if (alertLow !== null && typeof alertLow !== 'undefined' && val < alertLow) {
              return '#ff7675';
            }
            if (alertHigh !== null && typeof alertHigh !== 'undefined' && val > alertHigh) {
              return '#ff7675';
            }
            if (targetLow !== null && typeof targetLow !== 'undefined' && targetHigh !== null && typeof targetHigh !== 'undefined') {
              if (val >= targetLow && val <= targetHigh) {
                return '#10ac84';
              }
            }
            return '#feca57';
          });

          const annotations = {};
          if (targets && targets.length > 0) {
              const t = targets[0]; 
              
              // 1. Target Range (The "Sweet Spot" - Green Box)
              if (t.target_low !== null && t.target_high !== null) {
                  annotations.targetRange = {
                      type: 'box',
                      yMin: t.target_low,
                      yMax: t.target_high,
                      backgroundColor: 'rgba(29, 209, 161, 0.15)', // Reef Teal
                      borderWidth: 0,
                      label: {
                          display: true,
                          content: 'Target Range',
                          position: 'end',
                          color: '#10ac84',
                          font: { size: 10, weight: 'bold' }
                      }
                  };
              }

              // 2. Low Alert Line (Red)
              if (t.alert_low !== null && typeof t.alert_low !== 'undefined') {
                  annotations.alertLow = {
                      type: 'line',
                      yMin: t.alert_low,
                      yMax: t.alert_low,
                      borderColor: '#ff7675',
                      borderWidth: 2,
                      borderDash: [6, 6],
                      label: {
                          display: true,
                          content: 'Low Alert: ' + t.alert_low,
                          position: 'start',
                          backgroundColor: '#ff7675',
                          color: 'white',
                          font: { size: 10 }
                      }
                  };
              }

              // 3. High Alert Line (Red)
              if (t.alert_high !== null && typeof t.alert_high !== 'undefined') {
                  annotations.alertHigh = {
                      type: 'line',
                      yMin: t.alert_high,
                      yMax: t.alert_high,
                      borderColor: '#ff7675',
                      borderWidth: 2,
                      borderDash: [6, 6],
                      label: {
                          display: true,
                          content: 'High Alert: ' + t.alert_high,
                          position: 'start',
                          backgroundColor: '#ff7675',
                          color: 'white',
                          font: { size: 10 }
                      }
                  };
              }
          }

          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Reading',
                data: dataPoints,
                borderColor: '#00d2d3', // Reef Metrics Cyan
                backgroundColor: 'rgba(0, 210, 211, 0.1)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: pointColors,
                pointBorderColor: pointColors
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { display: false },
                annotation: { annotations: annotations }
              },
              scales: {
                y: { grid: { borderDash: [2, 4], color: '#e9ecef' } },
                x: { display: false }
              }
            }
          });
      } catch (err) {
          console.error("Chart Error:", err);
      }
  });
</script>
{% endblock %}
