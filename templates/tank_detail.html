{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h2 mb-0 fw-bold">{{ tank.name }}</h1>
    <div class="text-muted small d-flex gap-3 align-items-center mt-1">
      <span>ID: {{ tank.id }}</span>
      {% if tank.volume_l %}
        <span class="badge bg-light text-secondary border fs-6">{{ tank.volume_l }} Liters</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}/dosing-log">Dosing Log</a>
    <a class="btn btn-primary" href="/tanks/{{ tank.id }}/add">Add Reading</a>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        Settings
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/targets">Targets</a></li>
        <li><a class="dropdown-item" href="/tanks/{{ tank.id }}/profile">Edit Profile</a></li>
        <li><hr class="dropdown-divider"></li>
        <li>
             <form method="post" action="/tanks/{{ tank.id }}/delete" onsubmit="return confirm('Really delete?');" class="d-inline">
                <button class="dropdown-item text-danger" type="submit">Delete Tank</button>
             </form>
        </li>
      </ul>
    </div>
  </div>
</div>

<h4 class="mb-3">Latest Readings</h4>
<div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 mb-5">
  {% for p in params %}
    {% set val = latest_vals.get(p.id) %}
    {% set target = target_map.get(p.name) %}
    
    {% set status_class = "border-secondary-subtle" %}
    {% if val is not none and target %}
        {% if target.alert_low and val < target.alert_low %}{% set status_class = "border-danger bg-danger-subtle" %}{% endif %}
        {% if target.alert_high and val > target.alert_high %}{% set status_class = "border-danger bg-danger-subtle" %}{% endif %}
    {% endif %}

    <div class="col">
      <div class="card h-100 {{ status_class }} shadow-sm">
        <div class="card-body p-3">
          <div class="text-muted small text-uppercase fw-bold mb-1">{{ p.name }}</div>
          <div class="d-flex align-items-baseline gap-1">
             <span class="h3 mb-0 fw-bold">{{ val|fmt2 if val is not none else "-" }}</span>
             <span class="text-muted small">{{ p.unit }}</span>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">History</h5>
    <form method="get" class="d-flex align-items-center gap-2">
      <select name="parameter" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for p in params %}
          <option value="{{ p.id }}" {% if selected_parameter_id == p.id %}selected{% endif %}>
            {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>
  <div class="card-body">
    <div style="height: 350px;">
      <canvas id="historyChart"></canvas>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white">
    <h5 class="card-title mb-0">Log</h5>
  </div>
  <div class="table-responsive">
    <table class="table table-hover mb-0 align-middle text-nowrap">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          {% for p in params %}
            <th class="text-center">{{ p.name }} <small class="text-muted fw-normal">({{ p.unit }})</small></th>
          {% endfor %}
          <th>Notes</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in recent_samples %}
          <tr>
            <td class="fw-medium">{{ s.taken_at|dtfmt }}</td>
            
            {% for p in params %}
              <td class="text-center">
                 {% set val = s.values_dict.get(p.id) if s.values_dict else None %}
                 {{ val|fmt2 if val is not none else "-" }}
              </td>
            {% endfor %}

            <td class="text-muted small text-wrap" style="max-width: 200px;">{{ s.notes or "" }}</td>
            <td class="text-end">
               <a href="/tanks/{{ tank.id }}/samples/{{ s.id }}" class="btn btn-sm btn-light">View</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // 1. Get Data
      const seriesData = {{ series|tojson }};
      const targets = {{ chart_targets|tojson }};
      const ctx = document.getElementById('historyChart');

      console.log("Chart Data Received:", seriesData); // Check your browser console (F12) to see this

      // 2. Safety Check: Is there data?
      if (!seriesData || seriesData.length === 0) {
          if (ctx) {
             const msg = "No history data found for this parameter.";
             const c = ctx.getContext('2d');
             c.font = "14px sans-serif";
             c.fillStyle = "#6c757d";
             c.textAlign = "center";
             c.fillText(msg, ctx.width / 2, ctx.height / 2);
          }
          return; 
      }

      // 3. Robust Date Parsing Helper
      // Handles ISO (2025-12-28) and EU/AU (28/12/2025) formats
      function parseDate(dateStr) {
          if (!dateStr) return new Date();
          
          // Try standard parsing first
          let d = new Date(dateStr);
          if (!isNaN(d.getTime())) return d;

          // If invalid, try manually parsing DD/MM/YYYY or DD-MM-YYYY
          // Assumes format: DD/MM/YYYY HH:MM...
          const parts = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})(?:\s+(\d{1,2}):(\d{1,2}))?/);
          if (parts) {
              // parts[1]=Day, parts[2]=Month, parts[3]=Year, parts[4]=Hour, parts[5]=Min
              return new Date(parts[3], parts[2] - 1, parts[1], parts[4] || 0, parts[5] || 0);
          }
          return new Date(); // Fallback
      }

      const labels = seriesData.map(d => {
        const date = parseDate(d.x);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      });
      
      const dataPoints = seriesData.map(d => d.y);

      // 4. Prepare Annotations (Target Lines)
      const annotations = {};
      if (targets && targets.length > 0) {
          const t = targets[0]; 
          if (t.low !== null) {
              annotations.lineLow = {
                  type: 'line', yMin: t.low, yMax: t.low, 
                  borderColor: 'rgba(25, 135, 84, 0.6)', borderWidth: 2, borderDash: [5, 5], 
                  label: { content: 'Low: ' + t.low, enabled: true, position: 'start' }
              };
          }
          if (t.high !== null) {
              annotations.lineHigh = {
                  type: 'line', yMin: t.high, yMax: t.high, 
                  borderColor: 'rgba(25, 135, 84, 0.6)', borderWidth: 2, borderDash: [5, 5], 
                  label: { content: 'High: ' + t.high, enabled: true, position: 'start' }
              };
          }
      }

      // 5. Configure Plugins safely
      const chartPlugins = {
        legend: { display: false }
      };

      if (typeof window['chartjs-plugin-annotation'] !== 'undefined' || (Chart.registry && Chart.registry.plugins.get('annotation'))) {
          chartPlugins.annotation = { annotations: annotations };
      }

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Reading',
            data: dataPoints,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: chartPlugins,
          scales: {
            y: { beginAtZero: false, grid: { borderDash: [2, 4] } },
            x: { 
                display: false,
                grid: { display: false } 
            }
          }
        }
      });
  });
</script>
{% endblock %}
