{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
  <div>
    <h1 class="h3 mb-0 fw-bold">All Readings</h1>
    <div class="text-muted small">{{ tank.name }}</div>
  </div>
  <div class="d-flex gap-2">
    <form method="post" action="/tanks/{{ tank.id }}/samples/dedupe" onsubmit="return confirm('Remove duplicate readings that share the same timestamp? This keeps the first entry and deletes the rest.');">
      <button class="btn btn-outline-danger" type="submit">
        <i class="bi bi-trash"></i> Remove Duplicates
      </button>
    </form>
    <a class="btn btn-outline-secondary" href="/tanks/{{ tank.id }}">
      <i class="bi bi-arrow-left"></i> Back to Tank
    </a>
  </div>
</div>

{% if deduped_count is not none %}
  <div class="alert alert-info">
    Removed {{ deduped_count }} duplicate {{ "entry" if deduped_count == 1 else "entries" }}.
  </div>
{% endif %}

<div class="card shadow-sm">
  <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0 fw-bold">Reading Log</h5>
    <span class="text-muted small">{{ samples|length }} entries</span>
  </div>
  <div class="table-responsive">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th class="ps-3">Date</th>
          {% for p in params %}
            {% if p.name not in ['Temperature', 'Salinity'] %}
              <th class="text-center">{{ p.name }}</th>
            {% endif %}
          {% endfor %}
          <th>Notes</th>
          <th class="text-end pe-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in samples %}
          <tr>
            <td class="fw-medium ps-3 text-navy">{{ s.taken_at|dtfmt }}</td>
            {% for p in params %}
              {% if p.name not in ['Temperature', 'Salinity'] %}
                {% set sv = sample_values.get(s.id, {}) %}
                {% set val = sv.get(p.id) %}
                <td class="text-center">
                  {% if val is not none %}
                    <span class="fw-semibold">{{ val|fmt2 }}</span> <small class="text-muted">{{ p.unit }}</small>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              {% endif %}
            {% endfor %}
            <td>{{ s.notes or "â€”" }}</td>
            <td class="text-end pe-3">
              <a class="btn btn-sm btn-outline-primary" href="/tanks/{{ tank.id }}/samples/{{ s.id }}">
                View
              </a>
            </td>
          </tr>
        {% endfor %}
        {% if samples|length == 0 %}
          <tr>
            <td class="text-center text-muted py-4" colspan="3">No readings yet.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
