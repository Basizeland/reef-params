{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h2 class="h5 mb-1">{% if kit %}Edit test kit{% else %}New test kit{% endif %}</h2>
        <div class="text-muted small">Optional metadata for the kit you used to measure a parameter.</div>
      </div>
      <a class="btn btn-outline-secondary" href="/settings/test-kits">Back</a>
    </div>

    <form method="post" action="/settings/test-kits/save" class="mt-3">
      {% if kit %}
        <input type="hidden" name="kit_id" value="{{ kit.id }}" />
      {% endif %}

      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Kit name</label>
          <input class="form-control" name="name" value="{{ kit.name if kit else '' }}" required />
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Parameter</label>
          <select class="form-select" name="parameter" required>
            {% for p in parameters %}
              <option value="{{ p.name }}" {% if kit and kit.parameter == p.name %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Output unit (optional)</label>
          <input class="form-control" name="unit" value="{{ kit.unit if kit and kit.unit else '' }}" placeholder="e.g. dKH, ppm" />
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Resolution (optional)</label>
          <input class="form-control" name="resolution" type="number" step="any" value="{{ kit.resolution if kit and kit.resolution is not none else '' }}" />
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Manufacturer accuracy (optional)</label>
          <div class="input-group">
            <span class="input-group-text">Â±</span>
            <input class="form-control" name="manufacturer_accuracy" type="number" step="any" value="{{ kit.manufacturer_accuracy if kit and kit.manufacturer_accuracy is not none else '' }}" aria-label="Manufacturer accuracy percentage" />
            <span class="input-group-text">%</span>
          </div>
          <div class="form-text">Enter the percentage accuracy (for example, 2.5).</div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Active</label>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="active" id="active" {% if not kit or kit.active %}checked{% endif %}>
            <label class="form-check-label" for="active">Use in dropdown</label>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Min value (optional)</label>
          <input class="form-control" name="min_value" type="number" step="any" value="{{ kit.min_value if kit and kit.min_value is not none else '' }}" />
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Max value (optional)</label>
          <input class="form-control" name="max_value" type="number" step="any" value="{{ kit.max_value if kit and kit.max_value is not none else '' }}" />
        </div>

        <div class="col-12">
          <label class="form-label">Notes</label>
          <textarea class="form-control" name="notes" rows="3">{{ kit.notes if kit and kit.notes else '' }}</textarea>
        </div>

        <div class="col-12">
          <hr>
          <h6 class="text-muted text-uppercase small mb-2">Conversion Chart (Optional)</h6>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Conversion Type</label>
          <select class="form-select" name="conversion_type">
            <option value="">No conversion</option>
            <option value="syringe_remaining_ml" {% if kit and kit.conversion_type == 'syringe_remaining_ml' %}selected{% endif %}>
              Syringe remaining (Salifert-style)
            </option>
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Conversion Table</label>
          <textarea class="form-control" name="conversion_table" rows="4" placeholder="remaining_ml,value (one per line)">{{ kit.conversion_table if kit and kit.conversion_table else '' }}</textarea>
          <div class="form-text">Example: 0.1,12.6 (one per line). Space-separated entries are accepted too.</div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Save</button>
          <a class="btn btn-outline-secondary" href="/settings/test-kits">Cancel</a>
        </div>
      </div>
    </form>

    {% if kit %}
    <form class="mt-3" method="post" action="/settings/test-kits/{{ kit.id }}/delete" onsubmit="return confirm('Delete this kit?')">
      <button class="btn btn-outline-danger" type="submit">Delete test kit</button>
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}
